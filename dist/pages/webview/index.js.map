{"version":3,"file":"pages/webview/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AC9KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/./src/pages/webview/index.tsx?fcb8","webpack://eco-viz-mini/._src_pages_webview_index.tsx"],"sourcesContent":["import _regenerator from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/regenerator.js\";\nimport _typeof from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/typeof.js\";\nimport _asyncToGenerator from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport React, { useState } from 'react';\nimport { WebView, View, Text } from '@tarojs/components';\nimport Taro, { useLoad } from '@tarojs/taro';\nimport { handleLoginSuccess } from '../../utils/auth';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nexport default function WebviewPage() {\n  var _useState = useState(''),\n    _useState2 = _slicedToArray(_useState, 2),\n    src = _useState2[0],\n    setSrc = _useState2[1];\n  useLoad(function (options) {\n    var url = options !== null && options !== void 0 && options.url ? decodeURIComponent(options.url) : '';\n    var codeVerifier = options !== null && options !== void 0 && options.code_verifier ? decodeURIComponent(options.code_verifier) : '';\n\n    // 验证URL有效性\n    if (!url || url === '' || url === 'undefined' || url === 'null') {\n      Taro.showToast({\n        title: '登录URL无效',\n        icon: 'none'\n      });\n      setTimeout(function () {\n        Taro.navigateBack();\n      }, 2000);\n      return;\n    }\n\n    // 验证URL格式\n    try {\n      var urlObj = new URL(url);\n      if (!urlObj.protocol.startsWith('http')) {\n        throw new Error('Invalid protocol');\n      }\n    } catch (error) {\n      Taro.showToast({\n        title: '登录URL格式错误',\n        icon: 'none'\n      });\n      setTimeout(function () {\n        Taro.navigateBack();\n      }, 2000);\n      return;\n    }\n    setSrc(url);\n\n    // 存储 code_verifier\n    if (codeVerifier) {\n      Taro.setStorageSync('pkce_code_verifier', codeVerifier);\n    }\n  });\n\n  // 处理 WebView 消息\n  var handleMessage = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee(e) {\n      var _e$detail, _e$detail2, messageData, firstItem, _firstItem, _t;\n      return _regenerator().w(function (_context) {\n        while (1) switch (_context.p = _context.n) {\n          case 0:\n            _context.p = 0;\n            messageData = null; // 解析消息数据\n            if (e !== null && e !== void 0 && (_e$detail = e.detail) !== null && _e$detail !== void 0 && _e$detail.data && Array.isArray(e.detail.data) && e.detail.data.length > 0) {\n              firstItem = e.detail.data[0];\n              messageData = Array.isArray(firstItem) ? firstItem[0] : firstItem;\n            } else if (e !== null && e !== void 0 && (_e$detail2 = e.detail) !== null && _e$detail2 !== void 0 && _e$detail2.data && _typeof(e.detail.data) === 'object' && !Array.isArray(e.detail.data)) {\n              messageData = e.detail.data;\n            } else if (e !== null && e !== void 0 && e.data && Array.isArray(e.data) && e.data.length > 0) {\n              _firstItem = e.data[0];\n              messageData = Array.isArray(_firstItem) ? _firstItem[0] : _firstItem;\n            } else if (e !== null && e !== void 0 && e.data && _typeof(e.data) === 'object' && !Array.isArray(e.data)) {\n              messageData = e.data;\n            }\n            if (messageData) {\n              _context.n = 1;\n              break;\n            }\n            return _context.a(2);\n          case 1:\n            // 确保 messageData 不是数组\n            if (Array.isArray(messageData)) {\n              messageData = messageData[0];\n            }\n\n            // 处理不同类型的消息\n            if (!messageData.token) {\n              _context.n = 3;\n              break;\n            }\n            _context.n = 2;\n            return handleLoginSuccess(messageData.token);\n          case 2:\n            _context.n = 6;\n            break;\n          case 3:\n            if (!(messageData.type === 'url_hash' && messageData.temp_token)) {\n              _context.n = 5;\n              break;\n            }\n            _context.n = 4;\n            return handleLoginSuccess(messageData.temp_token);\n          case 4:\n            _context.n = 6;\n            break;\n          case 5:\n            if (messageData.error) {\n              // 登录失败\n              Taro.showModal({\n                title: '登录失败',\n                content: messageData.error || '登录失败，请重试',\n                showCancel: false\n              });\n            }\n          case 6:\n            _context.n = 8;\n            break;\n          case 7:\n            _context.p = 7;\n            _t = _context.v;\n            console.error('处理登录消息失败:', _t);\n          case 8:\n            return _context.a(2);\n        }\n      }, _callee, null, [[0, 7]]);\n    }));\n    return function handleMessage(_x) {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  // 处理 WebView 加载错误\n  var handleError = function handleError(e) {\n    Taro.showModal({\n      title: '加载失败',\n      content: '无法加载登录页面，请检查网络连接',\n      showCancel: true,\n      confirmText: '重试',\n      cancelText: '返回',\n      success: function success(res) {\n        if (res.confirm) {\n          // 刷新页面\n          window.location.reload();\n        } else {\n          Taro.navigateBack();\n        }\n      }\n    });\n  };\n  return /*#__PURE__*/_jsx(View, {\n    style: {\n      height: '100vh',\n      width: '100vw'\n    },\n    children: src ? /*#__PURE__*/_jsx(WebView, {\n      src: src,\n      style: {\n        height: '100vh',\n        width: '100vw'\n      },\n      onMessage: handleMessage,\n      onError: handleError\n    }) : /*#__PURE__*/_jsx(View, {\n      style: {\n        height: '100vh',\n        display: 'flex',\n        justifyContent: 'center',\n        alignItems: 'center'\n      },\n      children: /*#__PURE__*/_jsx(Text, {\n        children: \"\\u6B63\\u5728\\u521D\\u59CB\\u5316...\"\n      })\n    })\n  });\n}","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/webview/index!./index.tsx\"\nvar config = {\"navigationBarTitleText\":\"登录认证\"};\n\n\nvar inst = Page(createPageConfig(component, 'pages/webview/index', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}