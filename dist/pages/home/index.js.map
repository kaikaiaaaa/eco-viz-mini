{"version":3,"file":"pages/home/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACp7BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/./src/pages/home/index.tsx?7622","webpack://eco-viz-mini/._src_pages_home_index.tsx"],"sourcesContent":["import _defineProperty from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport _objectSpread from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regenerator from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/regenerator.js\";\nimport _asyncToGenerator from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"/Users/insentek/WorkSpace/insentek-web/eco-viz-mini-program/eco-viz-mini/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';\nimport { View, Text, Image, Input, Picker } from '@tarojs/components';\nimport { AtTabs, AtTabsPane, AtList, AtActivityIndicator, AtMessage } from 'taro-ui';\nimport Taro from '@tarojs/taro';\nimport api from '../../utils/api';\nimport { getAuthHeaders, wechatSilentLogin } from '../../utils/auth';\nimport 'taro-ui/dist/style/index.scss';\nimport './index.scss';\n\n// 导入设备图标\nimport { jsx as _jsx, jsxs as _jsxs } from \"react/jsx-runtime\";\nvar iconSq = require('../../assets/images/icon-sq.png');\nvar iconQx = require('../../assets/images/icon-qx.png');\nvar iconZhishang = require('../../assets/images/icon-zhishang.png');\nvar iconTianqiqxz = require('../../assets/images/icon-tianqiqxz.png');\n// 导入搜索图标\nvar iconSearch = require('../../assets/images/icon-search.png');\nvar iconDown = require('../../assets/images/icon-down.png');\n\n// 设备图标列表\nvar deviceIconList = [{\n  connectorIdentifier: 'huayi',\n  deviceType: '1',\n  icon: iconSq\n}, {\n  connectorIdentifier: 'huayi',\n  deviceType: '2',\n  icon: iconQx\n}, {\n  connectorIdentifier: 'ecois',\n  deviceType: '1',\n  icon: iconZhishang\n}, {\n  connectorIdentifier: 'ecois',\n  deviceType: '2',\n  icon: iconTianqiqxz\n}];\nvar deviceStatusList = [{\n  label: '在线',\n  value: 'Online',\n  color: '#52c41a'\n}, {\n  label: '离线',\n  value: 'Offline',\n  color: '#F1AE55'\n}];\n\n// 获取设备图标\nvar getDeviceIcon = function getDeviceIcon(connectorIdentifier, deviceType) {\n  var icon = deviceIconList.find(function (item) {\n    return item.connectorIdentifier === connectorIdentifier && item.deviceType === deviceType;\n  });\n  return icon ? icon.icon : null;\n};\nvar getDeviceStatusInfo = function getDeviceStatusInfo(statusCode) {\n  if (!statusCode) {\n    return null;\n  }\n  var status = deviceStatusList.find(function (item) {\n    return item.value === statusCode;\n  });\n  return status || {\n    label: '未知',\n    color: '#fa607e'\n  };\n};\nvar appendSuffix = function appendSuffix(value, suffix) {\n  if (!value) {\n    return value;\n  }\n  return value.endsWith(suffix) ? value : \"\".concat(value).concat(suffix);\n};\n\n// 格式化相对时间\nvar formatRelativeTime = function formatRelativeTime(timestamp) {\n  if (!timestamp) {\n    return '从未上报';\n  }\n  try {\n    var deviceLastUpdate = new Date(timestamp);\n    var now = new Date();\n    var diffMinutes = Math.floor((now.getTime() - deviceLastUpdate.getTime()) / 1000 / 60);\n    if (diffMinutes < 1) {\n      return '刚刚';\n    } else if (diffMinutes < 60) {\n      return \"\".concat(diffMinutes, \"\\u5206\\u949F\\u524D\");\n    } else if (diffMinutes < 1440) {\n      // 24小时\n      var diffHours = Math.floor(diffMinutes / 60);\n      return \"\".concat(diffHours, \"\\u5C0F\\u65F6\\u524D\");\n    } else {\n      var diffDays = Math.floor(diffMinutes / 1440);\n      return \"\".concat(diffDays, \"\\u5929\\u524D\");\n    }\n  } catch (error) {\n    return '从未上报';\n  }\n};\n\n// 格式化地理位置\nvar formatLocation = function formatLocation(item) {\n  var segments = [];\n  if (item.province) {\n    segments.push(appendSuffix(item.province, '省'));\n  }\n  if (item.city) {\n    segments.push(appendSuffix(item.city, '市'));\n  }\n  if (item.district) {\n    segments.push(item.district);\n  }\n  if (segments.length > 0) {\n    return segments.join('');\n  }\n  return item.location || '--';\n};\nexport default function HomePage() {\n  var _useState = useState(null),\n    _useState2 = _slicedToArray(_useState, 2),\n    userInfo = _useState2[0],\n    setUserInfo = _useState2[1];\n  var _useState3 = useState(true),\n    _useState4 = _slicedToArray(_useState3, 2),\n    loading = _useState4[0],\n    setLoading = _useState4[1];\n  var _useState5 = useState(true),\n    _useState6 = _slicedToArray(_useState5, 2),\n    groupsLoading = _useState6[0],\n    setGroupsLoading = _useState6[1];\n  var _useState7 = useState([]),\n    _useState8 = _slicedToArray(_useState7, 2),\n    groups = _useState8[0],\n    setGroups = _useState8[1];\n  var _useState9 = useState(0),\n    _useState0 = _slicedToArray(_useState9, 2),\n    tabIdx = _useState0[0],\n    setTabIdx = _useState0[1];\n  var _useState1 = useState({}),\n    _useState10 = _slicedToArray(_useState1, 2),\n    listsByGroup = _useState10[0],\n    setListsByGroup = _useState10[1];\n  var _useState11 = useState(''),\n    _useState12 = _slicedToArray(_useState11, 2),\n    searchValue = _useState12[0],\n    setSearchValue = _useState12[1];\n  var _useState13 = useState(''),\n    _useState14 = _slicedToArray(_useState13, 2),\n    searchKeyword = _useState14[0],\n    setSearchKeyword = _useState14[1]; // 实际用于搜索的关键词\n  var _useState15 = useState('all'),\n    _useState16 = _slicedToArray(_useState15, 2),\n    deviceTypeFilter = _useState16[0],\n    setDeviceTypeFilter = _useState16[1]; // 设备类型筛选：all, 1, 2\n  var _useState17 = useState(0),\n    _useState18 = _slicedToArray(_useState17, 2),\n    headerHeight = _useState18[0],\n    setHeaderHeight = _useState18[1];\n  var deviceTypeOptions = useMemo(function () {\n    return [{\n      label: '全部设备',\n      value: 'all'\n    }, {\n      label: '墒情设备',\n      value: '1'\n    }, {\n      label: '气象设备',\n      value: '2'\n    }];\n  }, []);\n\n  // 使用ref来避免闭包陷阱，存储最新的状态值\n  var searchKeywordRef = useRef('');\n  var deviceTypeFilterRef = useRef('all');\n  var listsByGroupRef = useRef({});\n  var initGroupsCalledRef = useRef(false);\n  var searchReloadingRef = useRef(false); // 防止搜索重新加载的重复触发\n  var prevSearchKeywordRef = useRef(''); // 跟踪上一次的搜索关键词\n  var prevDeviceTypeFilterRef = useRef('all'); // 跟踪上一次的设备类型筛选\n  var redirectingToLoginRef = useRef(false);\n  var updateTabBarBadge = useCallback(function (count) {\n    try {\n      if (count > 0) {\n        Taro.setTabBarBadge({\n          index: 1,\n          text: count > 99 ? '99+' : String(count)\n        });\n      } else {\n        Taro.removeTabBarBadge({\n          index: 1\n        });\n      }\n    } catch (error) {\n      console.warn('更新消息角标失败:', error);\n    }\n  }, []);\n  var refreshUnreadMessageBadge = useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee() {\n    var accessToken, resp, _resp$data$total, _resp$data, total, _t;\n    return _regenerator().w(function (_context) {\n      while (1) switch (_context.p = _context.n) {\n        case 0:\n          // 先检查是否有token，没有token就不调用接口\n          accessToken = Taro.getStorageSync('logto_token');\n          if (accessToken) {\n            _context.n = 1;\n            break;\n          }\n          console.log('⏭️ 未登录，跳过刷新消息角标');\n          return _context.a(2);\n        case 1:\n          _context.p = 1;\n          _context.n = 2;\n          return api.getMessages({\n            page: 1,\n            pageSize: 1,\n            isRead: 'false'\n          });\n        case 2:\n          resp = _context.v;\n          if ((resp === null || resp === void 0 ? void 0 : resp.code) === 0) {\n            total = (_resp$data$total = (_resp$data = resp.data) === null || _resp$data === void 0 ? void 0 : _resp$data.total) !== null && _resp$data$total !== void 0 ? _resp$data$total : 0;\n            updateTabBarBadge(total);\n          }\n          _context.n = 4;\n          break;\n        case 3:\n          _context.p = 3;\n          _t = _context.v;\n          console.warn('获取未读消息数量失败:', _t);\n        case 4:\n          return _context.a(2);\n      }\n    }, _callee, null, [[1, 3]]);\n  })), [updateTabBarBadge]);\n\n  // 同步ref和state\n  useEffect(function () {\n    searchKeywordRef.current = searchKeyword;\n  }, [searchKeyword]);\n  useEffect(function () {\n    deviceTypeFilterRef.current = deviceTypeFilter;\n  }, [deviceTypeFilter]);\n  useEffect(function () {\n    listsByGroupRef.current = listsByGroup;\n  }, [listsByGroup]);\n\n  // 只在首次加载时检查登录状态\n  useEffect(function () {\n    loadUserInfo();\n  }, []);\n\n  // 登录完成后，刷新消息角标\n  useEffect(function () {\n    if (!loading) {\n      refreshUnreadMessageBadge();\n    }\n  }, [loading, refreshUnreadMessageBadge]);\n  useEffect(function () {\n    if (!loading) {\n      Taro.nextTick(function () {\n        var query = Taro.createSelectorQuery();\n        query.select('.home-fixed-header').boundingClientRect(function (rect) {\n          var resolvedRect = Array.isArray(rect) ? rect === null || rect === void 0 ? void 0 : rect[0] : rect;\n          if (resolvedRect && resolvedRect.height) {\n            setHeaderHeight(resolvedRect.height);\n          }\n        }).exec();\n      });\n    }\n  }, [loading]);\n\n  // 页面显示时只刷新消息角标，不重新检查登录（避免重复调用）\n  Taro.useDidShow(function () {\n    refreshUnreadMessageBadge();\n    // 移除 loadUserInfo() 调用，避免重复登录检查\n  });\n  useEffect(function () {\n    // 确保登录完成（loading为false）后再初始化分组和设备列表\n    if (!loading && !initGroupsCalledRef.current) {\n      // 再次确认有token\n      var accessToken = Taro.getStorageSync('logto_token');\n      if (accessToken) {\n        initGroupsCalledRef.current = true;\n        initGroupsAndFirstPage();\n      }\n    }\n  }, [loading]);\n  var loadUserInfo = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee2() {\n      var accessToken, loginTimestamp, expiresIn, result, now, tokenAge, maxAge, _result, finalToken, cachedUser, finalUser, meResp, data, _t2, _t3;\n      return _regenerator().w(function (_context2) {\n        while (1) switch (_context2.p = _context2.n) {\n          case 0:\n            _context2.p = 0;\n            accessToken = Taro.getStorageSync('logto_token');\n            loginTimestamp = Taro.getStorageSync('login_timestamp');\n            expiresIn = Taro.getStorageSync('token_expires_in');\n            if (!(!accessToken || !loginTimestamp || !expiresIn)) {\n              _context2.n = 5;\n              break;\n            }\n            if (redirectingToLoginRef.current) {\n              _context2.n = 3;\n              break;\n            }\n            redirectingToLoginRef.current = true;\n            _context2.n = 1;\n            return wechatSilentLogin();\n          case 1:\n            result = _context2.v;\n            if (result.success) {\n              _context2.n = 2;\n              break;\n            }\n            Taro.showToast({\n              title: '登录失败，请重试',\n              icon: 'none'\n            });\n            setLoading(false);\n            return _context2.a(2);\n          case 2:\n            // 登录成功后，重置redirectingToLoginRef，继续后续流程\n            redirectingToLoginRef.current = false;\n            _context2.n = 4;\n            break;\n          case 3:\n            return _context2.a(2);\n          case 4:\n            _context2.n = 9;\n            break;\n          case 5:\n            now = Date.now();\n            tokenAge = now - loginTimestamp;\n            maxAge = expiresIn * 1000;\n            if (!(tokenAge > maxAge)) {\n              _context2.n = 9;\n              break;\n            }\n            if (redirectingToLoginRef.current) {\n              _context2.n = 8;\n              break;\n            }\n            redirectingToLoginRef.current = true;\n            _context2.n = 6;\n            return wechatSilentLogin();\n          case 6:\n            _result = _context2.v;\n            if (_result.success) {\n              _context2.n = 7;\n              break;\n            }\n            Taro.showToast({\n              title: '登录已过期，请重试',\n              icon: 'none'\n            });\n            setLoading(false);\n            return _context2.a(2);\n          case 7:\n            // 登录成功后，重置redirectingToLoginRef，继续后续流程\n            redirectingToLoginRef.current = false;\n            _context2.n = 9;\n            break;\n          case 8:\n            return _context2.a(2);\n          case 9:\n            // 确保有有效的token后再继续\n            finalToken = Taro.getStorageSync('logto_token');\n            if (finalToken) {\n              _context2.n = 10;\n              break;\n            }\n            setLoading(false);\n            return _context2.a(2);\n          case 10:\n            redirectingToLoginRef.current = false;\n            cachedUser = Taro.getStorageSync('user_info');\n            finalUser = cachedUser;\n            if (!cachedUser) {\n              _context2.n = 11;\n              break;\n            }\n            setUserInfo(cachedUser);\n            _context2.n = 14;\n            break;\n          case 11:\n            _context2.p = 11;\n            _context2.n = 12;\n            return Taro.request({\n              url: \"\".concat(process.env.TARO_APP_BASE_API || '', \"/api/me/data\"),\n              method: 'GET',\n              header: getAuthHeaders()\n            });\n          case 12:\n            meResp = _context2.v;\n            if (meResp.statusCode === 200 && meResp.data && meResp.data.code === 0) {\n              data = meResp.data.data;\n              if (data !== null && data !== void 0 && data.user) {\n                Taro.setStorageSync('user_info', data.user);\n                setUserInfo(data.user);\n                finalUser = data.user;\n              }\n            }\n            _context2.n = 14;\n            break;\n          case 13:\n            _context2.p = 13;\n            _t2 = _context2.v;\n          case 14:\n            setLoading(false);\n            _context2.n = 16;\n            break;\n          case 15:\n            _context2.p = 15;\n            _t3 = _context2.v;\n            Taro.atMessage({\n              message: '登录信息获取失败',\n              type: 'error'\n            });\n            setLoading(false);\n          case 16:\n            return _context2.a(2);\n        }\n      }, _callee2, null, [[11, 13], [0, 15]]);\n    }));\n    return function loadUserInfo() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n  var initGroupsAndFirstPage = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee3() {\n      var resp, _resp$data2, list, _t4;\n      return _regenerator().w(function (_context3) {\n        while (1) switch (_context3.p = _context3.n) {\n          case 0:\n            _context3.p = 0;\n            setGroupsLoading(true);\n            console.log('[Home] 开始加载分组...');\n            _context3.n = 1;\n            return api.getMiniGroups();\n          case 1:\n            resp = _context3.v;\n            console.log('[Home] 分组API响应:', resp);\n            if (!((resp === null || resp === void 0 ? void 0 : resp.code) === 0)) {\n              _context3.n = 4;\n              break;\n            }\n            list = ((_resp$data2 = resp.data) === null || _resp$data2 === void 0 ? void 0 : _resp$data2.groups) || [];\n            console.log('[Home] 分组列表:', list);\n            // 设置分组列表\n            setGroups(list);\n            if (!(list.length > 0)) {\n              _context3.n = 3;\n              break;\n            }\n            setTabIdx(0);\n            console.log('[Home] 开始加载第一个分组的设备...', list[0].id);\n            // 直接加载第一个分组的数据，不检查缓存（首次加载应该总是刷新）\n            _context3.n = 2;\n            return loadDevices(list[0].id, true);\n          case 2:\n            console.log('[Home] 第一个分组设备加载完成');\n          case 3:\n            _context3.n = 5;\n            break;\n          case 4:\n            console.warn('[Home] 分组API返回错误:', resp);\n            setGroups([]);\n          case 5:\n            _context3.n = 7;\n            break;\n          case 6:\n            _context3.p = 6;\n            _t4 = _context3.v;\n            console.error('[Home] 初始化分组失败:', _t4);\n            setGroups([]);\n            Taro.atMessage({\n              message: '加载分组失败',\n              type: 'error'\n            });\n          case 7:\n            _context3.p = 7;\n            setGroupsLoading(false);\n            return _context3.f(7);\n          case 8:\n            return _context3.a(2);\n        }\n      }, _callee3, null, [[0, 6, 7, 8]]);\n    }));\n    return function initGroupsAndFirstPage() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n  var ensureGroupState = function ensureGroupState(gid) {\n    var key = String(gid);\n    var currentLists = listsByGroupRef.current;\n    if (!currentLists[key]) {\n      var newState = {\n        list: [],\n        page: 0,\n        hasMore: true,\n        loading: false\n      };\n      // 先更新ref，再更新state，确保同步\n      listsByGroupRef.current = _objectSpread(_objectSpread({}, currentLists), {}, _defineProperty({}, key, newState));\n      setListsByGroup(function (prev) {\n        return _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, key, newState));\n      });\n    }\n  };\n  var loadDevices = useCallback(/*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee4(gid) {\n      var refresh,\n        key,\n        currentLists,\n        cur,\n        nextPage,\n        params,\n        currentSearchKeyword,\n        currentDeviceTypeFilter,\n        resp,\n        data,\n        merged,\n        _args4 = arguments,\n        _t5;\n      return _regenerator().w(function (_context4) {\n        while (1) switch (_context4.p = _context4.n) {\n          case 0:\n            refresh = _args4.length > 1 && _args4[1] !== undefined ? _args4[1] : false;\n            key = String(gid);\n            console.log(\"[Home] loadDevices \\u8C03\\u7528: groupId=\".concat(gid, \", refresh=\").concat(refresh));\n            ensureGroupState(gid);\n\n            // 使用ref获取最新状态，避免闭包陷阱\n            currentLists = listsByGroupRef.current;\n            cur = currentLists[key] || {\n              list: [],\n              page: 0,\n              hasMore: true,\n              loading: false\n            }; // 防止重复加载\n            if (!(!refresh && (cur.loading || !cur.hasMore))) {\n              _context4.n = 1;\n              break;\n            }\n            console.log(\"[Home] \\u8DF3\\u8FC7\\u52A0\\u8F7D: loading=\".concat(cur.loading, \", hasMore=\").concat(cur.hasMore));\n            return _context4.a(2, Promise.resolve());\n          case 1:\n            nextPage = refresh ? 1 : cur.page + 1;\n            console.log(\"[Home] \\u5F00\\u59CB\\u8BF7\\u6C42\\u8BBE\\u5907\\u5217\\u8868: page=\".concat(nextPage));\n\n            // 更新loading状态\n            setListsByGroup(function (prev) {\n              var updated = _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, key, _objectSpread(_objectSpread({}, cur), {}, {\n                loading: true\n              })));\n              listsByGroupRef.current = updated;\n              return updated;\n            });\n            _context4.p = 2;\n            params = {\n              groupId: gid,\n              page: nextPage,\n              pageSize: 20\n            }; // 使用ref获取最新的搜索关键词和设备类型筛选\n            currentSearchKeyword = searchKeywordRef.current.trim();\n            currentDeviceTypeFilter = deviceTypeFilterRef.current;\n            if (currentSearchKeyword) {\n              params.search = currentSearchKeyword;\n            }\n            if (currentDeviceTypeFilter !== 'all') {\n              params.devicetype = currentDeviceTypeFilter;\n            }\n            _context4.n = 3;\n            return api.getMiniDevices(params);\n          case 3:\n            resp = _context4.v;\n            console.log(\"[Home] \\u8BBE\\u5907\\u5217\\u8868API\\u54CD\\u5E94:\", resp);\n            if ((resp === null || resp === void 0 ? void 0 : resp.code) === 0) {\n              data = resp.data;\n              merged = refresh ? data.list : cur.list.concat(data.list);\n              console.log(\"[Home] \\u8BBE\\u5907\\u5217\\u8868\\u52A0\\u8F7D\\u6210\\u529F: \\u603B\\u6570=\".concat(merged.length, \", \\u5F53\\u524D\\u9875=\").concat(data.page, \", \\u662F\\u5426\\u6709\\u66F4\\u591A=\").concat(data.hasMore));\n              setListsByGroup(function (prev) {\n                var updated = _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, key, {\n                  list: merged,\n                  page: data.page,\n                  hasMore: data.hasMore,\n                  loading: false\n                }));\n                listsByGroupRef.current = updated;\n                return updated;\n              });\n            } else {\n              console.warn(\"[Home] \\u8BBE\\u5907\\u5217\\u8868API\\u8FD4\\u56DE\\u9519\\u8BEF:\", resp);\n              setListsByGroup(function (prev) {\n                var updated = _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, key, _objectSpread(_objectSpread({}, cur), {}, {\n                  loading: false\n                })));\n                listsByGroupRef.current = updated;\n                return updated;\n              });\n            }\n            _context4.n = 5;\n            break;\n          case 4:\n            _context4.p = 4;\n            _t5 = _context4.v;\n            console.error(\"[Home] \\u52A0\\u8F7D\\u8BBE\\u5907\\u5217\\u8868\\u5931\\u8D25:\", _t5);\n            setListsByGroup(function (prev) {\n              var updated = _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, key, _objectSpread(_objectSpread({}, cur), {}, {\n                loading: false\n              })));\n              listsByGroupRef.current = updated;\n              return updated;\n            });\n          case 5:\n            return _context4.a(2);\n        }\n      }, _callee4, null, [[2, 4]]);\n    }));\n    return function (_x) {\n      return _ref4.apply(this, arguments);\n    };\n  }(), []);\n\n  // 搜索防抖处理\n  useEffect(function () {\n    var timer = setTimeout(function () {\n      setSearchKeyword(searchValue);\n    }, 500); // 500ms 防抖\n    return function () {\n      return clearTimeout(timer);\n    };\n  }, [searchValue]);\n\n  // 搜索关键词变化时重新加载（只在搜索关键词或筛选条件变化时触发）\n  useEffect(function () {\n    // 检查是否真的发生了变化（避免初始化时触发）\n    var searchChanged = searchKeyword !== prevSearchKeywordRef.current;\n    var filterChanged = deviceTypeFilter !== prevDeviceTypeFilterRef.current;\n    if (!searchChanged && !filterChanged) {\n      // 没有变化，不执行\n      return;\n    }\n\n    // 更新prevRef\n    prevSearchKeywordRef.current = searchKeyword;\n    prevDeviceTypeFilterRef.current = deviceTypeFilter;\n\n    // 防止在groups或tabIdx变化时触发（这些变化由其他逻辑处理）\n    // 需要等待loading完成且groups已初始化\n    if (!loading && groups.length > 0 && tabIdx >= 0 && groups[tabIdx] && !searchReloadingRef.current) {\n      searchReloadingRef.current = true;\n      var currentGroupId = groups[tabIdx].id;\n\n      // 重置当前分组的状态并重新加载\n      var key = String(currentGroupId);\n      setListsByGroup(function (prev) {\n        var updated = _objectSpread({}, prev);\n        delete updated[key];\n        listsByGroupRef.current = updated;\n        return updated;\n      });\n\n      // 直接调用loadDevices，ensureGroupState会处理状态初始化\n      loadDevices(currentGroupId, true).then(function () {\n        searchReloadingRef.current = false;\n      }).catch(function () {\n        searchReloadingRef.current = false;\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [searchKeyword, deviceTypeFilter]); // 只依赖搜索相关的状态\n  var onTabChange = useCallback(/*#__PURE__*/function () {\n    var _ref5 = _asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee5(idx) {\n      var gid;\n      return _regenerator().w(function (_context5) {\n        while (1) switch (_context5.n) {\n          case 0:\n            setTabIdx(idx);\n            // 直接使用groups，因为useCallback会在groups变化时重新创建\n            if (!groups[idx]) {\n              _context5.n = 1;\n              break;\n            }\n            gid = groups[idx].id; // 切换tab时总是重新加载，确保应用当前的筛选条件（搜索关键词和设备类型）\n            _context5.n = 1;\n            return loadDevices(gid, true);\n          case 1:\n            return _context5.a(2);\n        }\n      }, _callee5);\n    }));\n    return function (_x2) {\n      return _ref5.apply(this, arguments);\n    };\n  }(), [groups, loadDevices]);\n  var onPullDownRefresh = useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee6() {\n    var currentGroups, currentTabIdx;\n    return _regenerator().w(function (_context6) {\n      while (1) switch (_context6.n) {\n        case 0:\n          currentGroups = groups;\n          currentTabIdx = tabIdx;\n          if (!currentGroups[currentTabIdx]) {\n            _context6.n = 1;\n            break;\n          }\n          _context6.n = 1;\n          return loadDevices(currentGroups[currentTabIdx].id, true);\n        case 1:\n          Taro.stopPullDownRefresh();\n        case 2:\n          return _context6.a(2);\n      }\n    }, _callee6);\n  })), [groups, tabIdx, loadDevices]);\n  var onReachBottom = useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regenerator().m(function _callee7() {\n    var currentGroups, currentTabIdx;\n    return _regenerator().w(function (_context7) {\n      while (1) switch (_context7.n) {\n        case 0:\n          currentGroups = groups;\n          currentTabIdx = tabIdx;\n          if (!currentGroups[currentTabIdx]) {\n            _context7.n = 1;\n            break;\n          }\n          _context7.n = 1;\n          return loadDevices(currentGroups[currentTabIdx].id, false);\n        case 1:\n          return _context7.a(2);\n      }\n    }, _callee7);\n  })), [groups, tabIdx, loadDevices]);\n\n  // 注册下拉刷新和上拉加载（Taro hooks需要在组件顶层调用）\n  // 使用useCallback确保回调函数稳定，避免重复注册导致的问题\n  // @ts-ignore\n  Taro.usePullDownRefresh(onPullDownRefresh);\n  // @ts-ignore\n  Taro.useReachBottom(onReachBottom);\n  var handleSearchChange = function handleSearchChange(value) {\n    setSearchValue(value);\n  };\n  var handleSearchClear = function handleSearchClear() {\n    setSearchValue('');\n    setSearchKeyword('');\n  };\n  var handleDeviceTypeChange = function handleDeviceTypeChange(value) {\n    setDeviceTypeFilter(value);\n    // 不需要手动重置，useEffect会自动处理\n  };\n  var handleDeviceTypePickerChange = function handleDeviceTypePickerChange(event) {\n    var _event$detail$value, _event$detail, _deviceTypeOptions$in;\n    var index = Number((_event$detail$value = event === null || event === void 0 || (_event$detail = event.detail) === null || _event$detail === void 0 ? void 0 : _event$detail.value) !== null && _event$detail$value !== void 0 ? _event$detail$value : 0);\n    var selected = ((_deviceTypeOptions$in = deviceTypeOptions[index]) === null || _deviceTypeOptions$in === void 0 ? void 0 : _deviceTypeOptions$in.value) || 'all';\n    handleDeviceTypeChange(selected);\n  };\n  var currentDeviceTypeLabel = useMemo(function () {\n    var found = deviceTypeOptions.find(function (option) {\n      return option.value === deviceTypeFilter;\n    });\n    return found ? found.label : '全部设备';\n  }, [deviceTypeFilter, deviceTypeOptions]);\n\n  // 使用useMemo缓存tabList，避免每次渲染都重新计算（必须在条件返回之前）\n  var tabList = useMemo(function () {\n    return groups.map(function (g) {\n      return {\n        title: \"\".concat(g.name).concat(g.count !== undefined ? '(' + g.count + ')' : '')\n      };\n    });\n  }, [groups]);\n  var tabsCustomStyle = useMemo(function () {\n    return {\n      '--home-tabs-offset': \"\".concat(headerHeight, \"px\")\n    };\n  }, [headerHeight]);\n  if (loading || groupsLoading) {\n    return /*#__PURE__*/_jsx(View, {\n      className: \"home-loading\",\n      children: /*#__PURE__*/_jsx(AtActivityIndicator, {\n        mode: \"normal\",\n        size: 40,\n        content: \"\\u52A0\\u8F7D\\u4E2D...\",\n        color: \"#1B9AEE\"\n      })\n    });\n  }\n  if (groups.length === 0) {\n    return /*#__PURE__*/_jsx(View, {\n      className: \"home-empty-groups\",\n      children: \"\\u6682\\u65E0\\u5206\\u7EC4\\u6570\\u636E\"\n    });\n  }\n  return /*#__PURE__*/_jsxs(View, {\n    className: \"home-page\",\n    children: [/*#__PURE__*/_jsx(AtMessage, {}), /*#__PURE__*/_jsx(View, {\n      className: \"home-fixed-header\",\n      children: /*#__PURE__*/_jsxs(View, {\n        className: \"home-search-row\",\n        children: [/*#__PURE__*/_jsxs(View, {\n          className: \"home-search-bar\",\n          children: [/*#__PURE__*/_jsx(Image, {\n            src: iconSearch,\n            className: \"home-search-icon\",\n            mode: \"aspectFit\"\n          }), /*#__PURE__*/_jsx(Input, {\n            type: \"text\",\n            value: searchValue,\n            onInput: function onInput(e) {\n              return handleSearchChange(e.detail.value);\n            },\n            placeholder: \"\\u641C\\u7D22\\u8BBE\\u5907\\u540D\\u79F0\\u6216\\u7F16\\u53F7\",\n            placeholderStyle: \"color:#999\",\n            className: \"home-search-input\"\n          }), searchValue && /*#__PURE__*/_jsx(Text, {\n            onClick: handleSearchClear,\n            className: \"home-search-clear\",\n            children: \"\\u2715\"\n          })]\n        }), /*#__PURE__*/_jsx(Picker, {\n          mode: \"selector\",\n          range: deviceTypeOptions.map(function (option) {\n            return option.label;\n          }),\n          value: deviceTypeFilter === 'all' ? 0 : deviceTypeFilter === '1' ? 1 : 2,\n          onChange: handleDeviceTypePickerChange,\n          children: /*#__PURE__*/_jsxs(View, {\n            className: \"home-filter-select\",\n            children: [/*#__PURE__*/_jsx(Text, {\n              className: \"home-filter-select-label\",\n              children: currentDeviceTypeLabel\n            }), /*#__PURE__*/_jsx(Image, {\n              src: iconDown,\n              className: \"home-filter-select-arrow\",\n              mode: \"aspectFit\"\n            })]\n          })\n        })]\n      })\n    }), /*#__PURE__*/_jsx(View, {\n      className: \"home-tabs-wrapper\",\n      children: /*#__PURE__*/_jsx(AtTabs, {\n        className: \"home-tabs\",\n        current: tabIdx,\n        tabList: tabList,\n        onClick: onTabChange,\n        height: \"44\",\n        swipeable: true,\n        animated: true,\n        tabDirection: \"horizontal\",\n        customStyle: tabsCustomStyle,\n        children: groups.map(function (group, idx) {\n          var paneKey = String(group.id);\n          var paneState = listsByGroup[paneKey] || {\n            list: [],\n            loading: false,\n            hasMore: true,\n            page: 0\n          };\n          return /*#__PURE__*/_jsxs(AtTabsPane, {\n            current: tabIdx,\n            index: idx,\n            customStyle: {\n              padding: 0\n            },\n            children: [paneState.loading && paneState.list.length === 0 ? /*#__PURE__*/_jsx(View, {\n              className: \"home-pane-loading\",\n              children: /*#__PURE__*/_jsx(AtActivityIndicator, {\n                mode: \"normal\",\n                size: 40,\n                content: \"\\u52A0\\u8F7D\\u8BBE\\u5907\\u5217\\u8868...\",\n                color: \"#1B9AEE\"\n              })\n            }) : paneState.list.length === 0 ? /*#__PURE__*/_jsxs(View, {\n              className: \"empty\",\n              children: [\"\\u6682\\u65E0 \", group.name, \" \\u8BBE\\u5907\"]\n            }) : /*#__PURE__*/_jsx(AtList, {\n              hasBorder: false,\n              children: paneState.list.map(function (item) {\n                var deviceIcon = getDeviceIcon(item.connectorIdentifier || '', item.deviceType || '');\n                var location = formatLocation(item);\n                var lastUpdateTime = formatRelativeTime(item.lastUpdate);\n                var statusInfo = getDeviceStatusInfo(item.status);\n                return /*#__PURE__*/_jsxs(View, {\n                  onClick: function onClick() {\n                    Taro.navigateTo({\n                      url: \"/pages/device-detail/index?id=\".concat(item.id)\n                    });\n                  },\n                  className: \"home-device-item\",\n                  children: [/*#__PURE__*/_jsxs(View, {\n                    className: \"home-device-icon-wrapper\",\n                    children: [deviceIcon && /*#__PURE__*/_jsx(Image, {\n                      src: deviceIcon,\n                      className: \"home-device-icon\",\n                      mode: \"aspectFit\"\n                    }), statusInfo && /*#__PURE__*/_jsx(Text, {\n                      className: \"home-device-status-badge\",\n                      style: {\n                        backgroundColor: statusInfo.color\n                      },\n                      children: statusInfo.label\n                    })]\n                  }), /*#__PURE__*/_jsxs(View, {\n                    className: \"home-device-info\",\n                    children: [/*#__PURE__*/_jsxs(View, {\n                      children: [/*#__PURE__*/_jsx(Text, {\n                        className: \"home-device-name\",\n                        children: item.name || item.sn\n                      }), /*#__PURE__*/_jsxs(Text, {\n                        className: \"home-device-sn\",\n                        children: [\"No.\", item.sn]\n                      })]\n                    }), /*#__PURE__*/_jsx(Text, {\n                      className: \"home-device-location\",\n                      children: location\n                    }), /*#__PURE__*/_jsx(Text, {\n                      className: \"home-device-update\",\n                      children: lastUpdateTime ? \"\".concat(lastUpdateTime, \"\\u4E0A\\u62A5\") : '从未上报'\n                    })]\n                  }), /*#__PURE__*/_jsx(Text, {\n                    className: \"home-device-arrow\",\n                    children: \"\\u203A\"\n                  })]\n                }, item.id);\n              })\n            }), paneState.loading && paneState.list.length !== 0 && /*#__PURE__*/_jsx(View, {\n              className: \"home-load-more\",\n              children: /*#__PURE__*/_jsx(AtActivityIndicator, {\n                content: \"\\u52A0\\u8F7D\\u66F4\\u591A...\",\n                size: 26,\n                color: \"#3192ff\"\n              })\n            }), !paneState.hasMore && paneState.list.length > 0 && /*#__PURE__*/_jsx(View, {\n              className: \"home-no-more\",\n              children: \"\\u6CA1\\u6709\\u66F4\\u591A\\u4E86\"\n            })]\n          }, group.id);\n        })\n      })\n    })]\n  });\n}","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/home/index!./index.tsx\"\nvar config = {\"navigationBarTitleText\":\"首页\",\"enablePullDownRefresh\":true,\"backgroundTextStyle\":\"dark\"};\n\n\nvar inst = Page(createPageConfig(component, 'pages/home/index', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}