{"version":3,"file":"common.js","mappings":";;;;;;;;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;AClCA;AACA;AACA;;AAEA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;ACjLA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxBA;AAAA;AAAA;;AA4BA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AANA;AAAA;AAQA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AAGA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AA3CA;AAAA;AAAA;;AA8CA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAGA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAJA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AA5JA;AAAA;AAAA;;AA+JA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxCA;AAAA;AAAA;;AA0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/._src_config_index.ts","webpack://eco-viz-mini/._src_utils_api.ts","webpack://eco-viz-mini/._src_utils_auth.ts"],"sourcesContent":["// å°ç¨‹åºç¯å¢ƒé…ç½®\nconst ENV: 'dev' | 'prod' = 'dev'\n\nconst apiBaseUrls = {\n  dev: 'http://192.168.199.61:3000',\n  prod: 'https://ynsq.eboard.apps.aigrohub.com'\n} as const\n\nconst logtoRedirectUris = {\n  dev: 'http://192.168.199.61:3000/api/auth/mini-callback',\n  prod: 'https://ynsq.eboard.apps.aigrohub.com/api/auth/mini-callback'\n} as const\n\nexport const config = {\n  env: ENV,\n  // API é…ç½®\n  api: {\n    baseUrl: apiBaseUrls[ENV]\n  },\n  \n  // Logto é…ç½® - ä½¿ç”¨æ–°åˆ›å»ºçš„å°ç¨‹åºåº”ç”¨\n  logto: {\n    endpoint: 'https://login.eboard.apps.aigrohub.com',\n    appId: 'ctvdqppb8we5z1yz41qfg', // ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ App ID\n    apiResource: 'https://ynsq.eboard.apps.aigrohub.com/api',\n    redirectUri: logtoRedirectUris[ENV] // ä½¿ç”¨åç«¯APIå›è°ƒ\n  },\n  \n  // å¾®ä¿¡å°ç¨‹åºé…ç½®\n  weapp: {\n    appId: 'wxad0bc6972754b77c'\n  }\n}\n\nexport default config\n","import Taro from '@tarojs/taro'\nimport config from '../config'\nimport { navigateToWebViewLoginSimple } from './auth'\n\n// è¯·æ±‚æ‹¦æˆªå™¨\nconst request = (url: string, options: RequestInit = {}) => {\n  const token = Taro.getStorageSync('logto_token')\n  \n  return new Promise((resolve, reject) => {\n    Taro.request({\n      url: `${config.api.baseUrl}${url}`,\n      method: options.method as any || 'GET',\n      header: {\n        'Content-Type': 'application/json',\n        ...(token && { 'Authorization': `Bearer ${token}` }),\n        ...options.headers\n      },\n      data: options.body ? JSON.parse(options.body as string) : undefined,\n      success: (res) => {\n        if (res.statusCode === 401) {\n          // Token è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶è·³è½¬ç™»å½•\n          Taro.removeStorageSync('logto_token')\n          navigateToWebViewLoginSimple(); // ä¸èƒ½åŠ awaitï¼\n          reject(new Error('ç™»å½•å·²è¿‡æœŸ'))\n          return\n        }\n        \n        if (res.statusCode >= 200 && res.statusCode < 300) {\n          resolve(res.data)\n        } else {\n          reject(new Error(`è¯·æ±‚å¤±è´¥: ${res.statusCode}`))\n        }\n      },\n      fail: (error) => {\n        reject(error)\n      }\n    })\n  })\n}\n\n// API æ–¹æ³•å°è£…\nexport const api = {\n  // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå°ç¨‹åºä¸“ç”¨æ¥å£ï¼‰\n  getUserInfo: () => request('/api/mini/my-account'),\n\n  // æ›´æ–°ä¸ªäººä¿¡æ¯\n  updateProfile: (data: { username?: string; primaryEmail?: string; primaryPhone?: string; name?: string }) => {\n    return request('/api/mini/my-account/update-profile', {\n      method: 'PUT',\n      body: JSON.stringify(data)\n    })\n  },\n\n  // ä¿®æ”¹å¯†ç \n  changePassword: (data: { currentPassword: string; newPassword: string }) => {\n    return request('/api/mini/my-account/change-password', {\n      method: 'POST',\n      body: JSON.stringify(data)\n    })\n  },\n \n  // å°ç¨‹åºï¼šè·å–åˆ†ç»„ï¼ˆå½“å‰ç”¨æˆ·å¯è§ï¼‰\n  getMiniGroups: () => request('/api/mini/groups'),\n\n  // å°ç¨‹åºï¼šè·å–è®¾å¤‡åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰\n  getMiniDevices: (params: { groupId?: string | number, page?: number, pageSize?: number, keyword?: string, search?: string, devicetype?: string }) => {\n    const query = new URLSearchParams()\n    if (params.groupId !== undefined) query.set('groupId', String(params.groupId))\n    if (params.page !== undefined) query.set('page', String(params.page))\n    if (params.pageSize !== undefined) query.set('pageSize', String(params.pageSize))\n    // search å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ï¼Œä¸åå°ä¿æŒä¸€è‡´\n    if (params.search) {\n      query.set('search', params.search)\n    } else if (params.keyword) {\n      query.set('keyword', params.keyword)\n    }\n    if (params.devicetype) {\n      query.set('devicetype', params.devicetype)\n    }\n    const qs = query.toString() ? `?${query.toString()}` : ''\n    return request(`/api/mini/devices${qs}`)\n  },\n  \n  // è·å–è®¾å¤‡è¯¦æƒ…ï¼ˆä¿ç•™åŸæœ‰ Web ç«¯æ¥å£ï¼Œå¦‚åç»­éœ€è¦ï¼‰\n  getDeviceDetail: (id: number) => request(`/api/devices/${id}`),\n  \n  // è·å–è®¾å¤‡å‚æ•°\n  getDeviceParameters: (id: number) => request(`/api/devices/${id}/parameters`),\n  \n  // æ ¹æ®å‚æ•°åç§°åˆ—è¡¨è·å–å‚æ•°è¯¦æƒ…\n  getParametersInfo: (parameterNames: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameterNames.join(','))\n    return request(`/api/parameters?${params.toString()}`)\n  },\n  \n  // è·å–è®¾å¤‡å†å²æ•°æ®\n  getDeviceHistoryData: (id: number, params: { parameters: string, startDate: string, endDate: string }) => {\n    const query = new URLSearchParams()\n    query.set('parameters', params.parameters)\n    query.set('startDate', params.startDate)\n    query.set('endDate', params.endDate)\n    return request(`/api/devices/${id}/history-data?${query.toString()}`)\n  },\n  \n  // è·å–è®¾å¤‡æ•°æ®\n  getDeviceData: (id: number, params?: any) => {\n    const queryString = params ? `?${new URLSearchParams(params).toString()}` : ''\n    return request(`/api/devices/${id}/et-data${queryString}`)\n  },\n\n  // å°ç¨‹åºï¼šè·å–è®¾å¤‡é˜ˆå€¼é…ç½®\n  getDeviceThresholds: (deviceSn: string) => request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds`),\n\n  // å°ç¨‹åºï¼šåˆ›å»ºæˆ–æ›´æ–°è®¾å¤‡é˜ˆå€¼é…ç½®\n  saveDeviceThreshold: (deviceSn: string, data: { id?: number, parameter: string, lowerThreshold?: number | null, upperThreshold?: number | null, enabled?: boolean, nodeScopeType?: 'lte' | 'gte' | null, nodeScopeValue?: string | number | null }) => {\n    return request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds`, {\n      method: 'POST',\n      body: JSON.stringify(data)\n    })\n  },\n\n  // å°ç¨‹åºï¼šåˆ é™¤è®¾å¤‡é˜ˆå€¼é…ç½®\n  deleteDeviceThreshold: (deviceSn: string, thresholdId: number) => {\n    const query = new URLSearchParams()\n    query.set('id', String(thresholdId))\n    return request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds?${query.toString()}`, {\n      method: 'DELETE'\n    })\n  },\n\n  // å°ç¨‹åºï¼šè·å–æ¶ˆæ¯åˆ—è¡¨\n  getMessages: (params?: { page?: number, pageSize?: number, isRead?: 'true' | 'false' }) => {\n    const query = new URLSearchParams()\n    if (params?.page) query.set('page', String(params.page))\n    if (params?.pageSize) query.set('pageSize', String(params.pageSize))\n    if (params?.isRead) query.set('isRead', params.isRead)\n    const qs = query.toString() ? `?${query.toString()}` : ''\n    return request(`/api/mini/messages${qs}`)\n  },\n\n  // å°ç¨‹åºï¼šæ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»\n  markMessageRead: (messageId: number) => {\n    return request(`/api/mini/messages/${messageId}/read`, {\n      method: 'PUT'\n    })\n  },\n\n  // å°ç¨‹åºï¼šåˆ é™¤æ¶ˆæ¯\n  deleteMessage: (messageId: number) => {\n    return request(`/api/mini/messages/${messageId}`, {\n      method: 'DELETE'\n    })\n  },\n\n  // å°ç¨‹åºï¼šä¸€é”®æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»\n  markAllMessagesRead: () => {\n    return request('/api/mini/messages/read-all', {\n      method: 'PUT'\n    })\n  },\n\n  // è·å–å¢’æƒ…è®¾å¤‡æŒ‡æ ‡æ•°æ®ï¼ˆæœ€æ–°åˆ†æï¼‰\n  getMoistureIndicators: (deviceId: number, parameters: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameters.join(','))\n    return request(`/api/devices/${deviceId}/moisture-indicators?${params.toString()}`)\n  },\n\n  // è·å–æ°”è±¡è®¾å¤‡æŒ‡æ ‡æ•°æ®ï¼ˆæœ€æ–°åˆ†æï¼‰\n  getWeatherIndicators: (deviceId: number, parameters: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameters.join(','))\n    return request(`/api/devices/${deviceId}/analysis?type=weather&${params.toString()}`)\n  }\n}\n\nexport default api\n","import Taro from '@tarojs/taro'\nimport config from '../config'\n\n// ç”Ÿæˆéšæœºå­—ç¬¦ä¸² - ä½¿ç”¨æ›´å®‰å…¨çš„å­—ç¬¦é›†\nconst generateRandomString = (length: number) => {\n  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_' // ç§»é™¤ . å’Œ ~ é¿å… URL ç¼–ç é—®é¢˜\n  let result = ''\n  for (let i = 0; i < length; i++) {\n    result += charset.charAt(Math.floor(Math.random() * charset.length))\n  }\n  return result\n}\n\n// å°ç¨‹åºç¯å¢ƒçš„ Base64 ç¼–ç å®ç°\nconst base64Encode = (str: string) => {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\n  let result = ''\n  let i = 0\n  \n  while (i < str.length) {\n    const a = str.charCodeAt(i++)\n    const b = i < str.length ? str.charCodeAt(i++) : 0\n    const c = i < str.length ? str.charCodeAt(i++) : 0\n    \n    const bitmap = (a << 16) | (b << 8) | c\n    \n    result += chars.charAt((bitmap >> 18) & 63)\n    result += chars.charAt((bitmap >> 12) & 63)\n    result += i - 2 < str.length ? chars.charAt((bitmap >> 6) & 63) : '='\n    result += i - 1 < str.length ? chars.charAt(bitmap & 63) : '='\n  }\n  \n  return result\n}\n\n// ç”Ÿæˆ code_challenge (SHA256 + Base64URL)\nconst generateCodeChallenge = async (codeVerifier: string) => {\n  try {\n    // åœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Web Crypto API ç”ŸæˆçœŸæ­£çš„ SHA256\n    if (typeof crypto !== 'undefined' && crypto.subtle) {\n      const encoder = new TextEncoder()\n      const data = encoder.encode(codeVerifier)\n      const hash = await crypto.subtle.digest('SHA-256', data)\n      \n      // è½¬æ¢ä¸º Base64URL\n      const base64 = base64Encode(String.fromCharCode(...new Uint8Array(hash)))\n      const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n      \n      // SHA256çš„Base64URLç¼–ç åº”è¯¥æ˜¯43ä¸ªå­—ç¬¦\n      return base64url\n    } else {\n      throw new Error('Web Crypto API not available')\n    }\n  } catch (error) {\n    console.warn('SHA256 failed, using fallback:', error)\n    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç®€å•çš„ Base64 ç¼–ç ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰\n    const base64 = base64Encode(codeVerifier)\n    const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n    return base64url\n  }\n}\n\n\n\n// WebView ç™»å½• - ä½¿ç”¨ç®€åŒ–çš„ä¼šè¯IDæ–¹æ¡ˆ\nexport const navigateToWebViewLoginSimple = async () => {\n  try {\n    console.log('ğŸš€ è¯·æ±‚åç«¯ç”ŸæˆPKCEå‚æ•°...')\n    \n    // è°ƒç”¨åç«¯APIç”ŸæˆPKCEå‚æ•°\n    const response = await Taro.request({\n      url: `${config.api.baseUrl}/api/auth/mini-pkce`,\n      method: 'GET',\n      header: {\n        'Content-Type': 'application/json'\n      }\n    })\n    \n    if (response.statusCode === 200 && response.data.code === 0) {\n      const pkceData = response.data.data\n      console.log('âœ… PKCEå‚æ•°è·å–æˆåŠŸ:', pkceData.loginUrl.substring(0, 100) + '...')\n      \n      // å­˜å‚¨ code_verifier ç”¨äºåç»­çš„ token äº¤æ¢\n      Taro.setStorageSync('pkce_code_verifier', pkceData.codeVerifier)\n      \n      // è·³è½¬åˆ°WebViewé¡µé¢\n      const encodedUrl = encodeURIComponent(pkceData.loginUrl)\n      const encodedCodeVerifier = encodeURIComponent(pkceData.codeVerifier)\n      \n      // åŠ å¼º debug æ—¥å¿—å’ŒæŠ¥é”™æ˜¾ç¤º\n      Taro.navigateTo({\n        url: `/pages/webview/index?url=${encodedUrl}&code_verifier=${encodedCodeVerifier}`,\n        success: () => console.log('WebView ç™»å½•é¡µé¢è·³è½¬æˆåŠŸ'),\n        fail: (err) => {\n          console.error('WebView ç™»å½•é¡µé¢è·³è½¬å¤±è´¥', err)\n          Taro.showToast({ title: 'è·³è½¬ç™»å½•é¡µå¤±è´¥', icon: 'none' })\n        }\n      })\n    } else {\n      throw new Error(response.data.message || 'PKCEå‚æ•°ç”Ÿæˆå¤±è´¥')\n    }\n  } catch (error) {\n    console.error('âŒ WebViewç™»å½•å¤±è´¥:', error)\n    Taro.showToast({\n      title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',\n      icon: 'none'\n    })\n  }\n}\n\n\n// ç™»å½•æˆåŠŸåå¤„ç†ï¼ˆæœåŠ¡ç«¯ä»£ç†æ¨¡å¼ï¼‰\nexport const handleLoginSuccess = async (tempToken: string) => {\n  try {\n    console.log('ğŸ”„ å¤„ç†ä¸´æ—¶ tokenï¼ˆJWTè§£ç ï¼‰...')\n    console.log('Temp token length:', tempToken ? tempToken.length : 0)\n\n    // ========== JWT Token è§£ç  ==========\n    // JWT æ ¼å¼: header.payload.signature\n    // æˆ‘ä»¬åªéœ€è¦è§£ç  payload éƒ¨åˆ†æ¥è·å–æ•°æ®\n    const decodeJWT = (jwt: string): any => {\n      try {\n        const parts = jwt.split('.')\n        if (parts.length !== 3) {\n          throw new Error('æ— æ•ˆçš„ JWT æ ¼å¼')\n        }\n\n        // è§£ç  payloadï¼ˆç¬¬äºŒä¸ªéƒ¨åˆ†ï¼‰\n        const payload = parts[1]\n        \n        // Base64URL è§£ç \n        const safeBase64UrlDecodeToString = (input: string): string => {\n          // å°† Base64URL è½¬ä¸ºæ ‡å‡† Base64ï¼Œå¹¶è¡¥é½ '='\n          const base64 = input.replace(/-/g, '+').replace(/_/g, '/')\n          const padLen = (4 - (base64.length % 4)) % 4\n          const padded = base64 + '='.repeat(padLen)\n\n          const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\n          const rev: Record<string, number> = {}\n          for (let i = 0; i < alphabet.length; i++) rev[alphabet[i]] = i\n\n          const bytes: Array<number> = []\n          let buffer = 0\n          let bits = 0\n          for (let i = 0; i < padded.length; i++) {\n            const c = padded[i]\n            if (c === '=') break\n            const val = rev[c]\n            if (val === undefined) continue\n            buffer = (buffer << 6) | val\n            bits += 6\n            if (bits >= 8) {\n              bits -= 8\n              const byte = (buffer >> bits) & 0xff\n              bytes.push(byte)\n              buffer = buffer & ((1 << bits) - 1)\n            }\n          }\n\n          // UTF-8 è§£ç \n          let out = ''\n          for (let i = 0; i < bytes.length; ) {\n            const b0 = bytes[i++]\n            if (b0 < 0x80) {\n              out += String.fromCharCode(b0)\n            } else if (b0 >= 0xc0 && b0 < 0xe0) {\n              const b1 = bytes[i++]\n              out += String.fromCharCode(((b0 & 0x1f) << 6) | (b1 & 0x3f))\n            } else if (b0 >= 0xe0 && b0 < 0xf0) {\n              const b1 = bytes[i++]\n              const b2 = bytes[i++]\n              out += String.fromCharCode(\n                ((b0 & 0x0f) << 12) | ((b1 & 0x3f) << 6) | (b2 & 0x3f)\n              )\n            } else {\n              // è¶…è¿‡ BMP çš„å­—ç¬¦ï¼ˆ4 å­—èŠ‚ï¼‰ï¼Œè½¬ä¸ºä»£ç†å¯¹\n              const b1 = bytes[i++]\n              const b2 = bytes[i++]\n              const b3 = bytes[i++]\n              let codePoint =\n                ((b0 & 0x07) << 18) | ((b1 & 0x3f) << 12) | ((b2 & 0x3f) << 6) | (b3 & 0x3f)\n              codePoint -= 0x10000\n              out += String.fromCharCode(0xd800 + ((codePoint >> 10) & 0x3ff))\n              out += String.fromCharCode(0xdc00 + (codePoint & 0x3ff))\n            }\n          }\n          return out\n        }\n\n        const decodedStr = safeBase64UrlDecodeToString(payload)\n        const decoded = JSON.parse(decodedStr)\n\n        // éªŒè¯è¿‡æœŸæ—¶é—´ï¼ˆexp å­—æ®µï¼Œå•ä½ï¼šç§’ï¼‰\n        if (decoded.exp) {\n          const now = Math.floor(Date.now() / 1000)\n          if (decoded.exp < now) {\n            throw new Error('ä¸´æ—¶ token å·²è¿‡æœŸ')\n          }\n        }\n\n        return decoded\n      } catch (error) {\n        console.error('JWT è§£ç å¤±è´¥:', error)\n        throw new Error('æ— æ•ˆçš„ä¸´æ—¶å‡­è¯æ ¼å¼')\n      }\n    }\n\n    // è§£ç  JWT token\n    const decoded = decodeJWT(tempToken)\n\n    if (!decoded || !decoded.access_token) {\n      throw new Error('æ— æ•ˆçš„ä¸´æ—¶å‡­è¯')\n    }\n\n    const accessToken = decoded.access_token\n    const expiresIn = decoded.expires_in || 3600\n\n    // å­˜å‚¨ç”¨æˆ· access_tokenï¼ˆä¸åç«¯ç»Ÿä¸€ï¼‰\n    Taro.setStorageSync('logto_token', accessToken)\n    Taro.setStorageSync('token_expires_in', expiresIn)\n    Taro.setStorageSync('login_timestamp', Date.now())\n\n    // æ¸…é™¤ä¸´æ—¶ç™»å½•çŠ¶æ€\n    Taro.removeStorageSync('pkce_code_verifier')\n\n    // å°è¯•é€šè¿‡åç«¯ API è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ Logtoï¼‰\n    try {\n      const meResp = await Taro.request({\n        url: `${config.api.baseUrl}/api/me/data`,\n        method: 'GET',\n        header: getAuthHeaders()\n      })\n\n      if (meResp.statusCode === 200 && meResp.data && meResp.data.code === 0) {\n        const userData = meResp.data.data\n        if (userData?.user) {\n          const userInfo = userData.user\n          Taro.setStorageSync('user_info', userInfo)\n          // ç¼“å­˜ userId ç”¨äºè¯·æ±‚é€ä¼ \n          if (userInfo.id) {\n            Taro.setStorageSync('user_id', userInfo.id)\n          }\n          console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²è·å–å¹¶ç¼“å­˜')\n        }\n      }\n    } catch (e) {\n      console.warn('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼Œä¸å½±å“ç™»å½•ï¼‰:', e)\n      // ä¸å½±å“ç™»å½•æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ\n    }\n\n    console.log('âœ… ç™»å½•æˆåŠŸï¼Œä»¤ç‰Œå·²å­˜å‚¨')\n    Taro.showToast({ title: 'ç™»å½•æˆåŠŸ', icon: 'success' })\n\n    // è·³è½¬åˆ°é¦–é¡µ\n    setTimeout(() => {\n      Taro.switchTab({\n        url: '/pages/home/index',\n        fail: () => {\n          // å¦‚æœ switchTab å¤±è´¥ï¼Œä½¿ç”¨ reLaunch\n          Taro.reLaunch({ url: '/pages/home/index' })\n        }\n      })\n    }, 1000)\n  } catch (error) {\n    console.error('âŒ å¤„ç†ä¸´æ—¶ token å¤±è´¥:', error)\n    const errorMsg = error instanceof Error ? error.message : 'ç™»å½•éªŒè¯å¤±è´¥'\n    Taro.showToast({ title: errorMsg, icon: 'none' })\n  }\n}\n\n\n// æ£€æŸ¥ç™»å½•çŠ¶æ€\nexport const checkLoginStatus = async () => {\n  try {\n    // æ£€æŸ¥ logto_tokenï¼ˆWebViewç™»å½•ï¼‰\n    const accessToken = Taro.getStorageSync('logto_token')\n    const loginTimestamp = Taro.getStorageSync('login_timestamp')\n    const expiresIn = Taro.getStorageSync('token_expires_in')\n    \n    if (!accessToken || !loginTimestamp || !expiresIn) {\n      console.log('âŒ ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    // æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ\n    const now = Date.now()\n    const tokenAge = now - loginTimestamp\n    const maxAge = expiresIn * 1000 // è½¬æ¢ä¸ºæ¯«ç§’\n    \n    if (tokenAge > maxAge) {\n      console.log('âŒ Token å·²è¿‡æœŸï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€')\n      clearLoginData()\n      return { isLoggedIn: false }\n    }\n    \n    // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ\n    const userInfo = Taro.getStorageSync('user_info')\n    if (!userInfo) {\n      console.log('âŒ ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    console.log('âœ… ç™»å½•çŠ¶æ€æ£€æŸ¥æˆåŠŸ')\n    return {\n      isLoggedIn: true,\n      user: userInfo,\n      access_token: accessToken\n    }\n  } catch (error) {\n    console.error('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)\n    return { isLoggedIn: false }\n  }\n}\n\n// æ¸…é™¤ç™»å½•æ•°æ®\nexport const clearLoginData = () => {\n  try {\n    // æ¸…é™¤æ‰€æœ‰ç™»å½•ç›¸å…³çš„å­˜å‚¨\n    Taro.removeStorageSync('logto_token')\n    Taro.removeStorageSync('user_info')\n    Taro.removeStorageSync('user_id')\n    Taro.removeStorageSync('token_expires_in')\n    Taro.removeStorageSync('login_timestamp')\n    Taro.removeStorageSync('pkce_code_verifier')\n    console.log('âœ… ç™»å½•æ•°æ®å·²æ¸…é™¤')\n  } catch (error) {\n    console.error('âŒ æ¸…é™¤ç™»å½•æ•°æ®å¤±è´¥:', error)\n  }\n}\n\n// è·å–å¸¦è®¤è¯å¤´çš„è¯·æ±‚é…ç½®\nexport const getAuthHeaders = () => {\n  // ä»…ä½¿ç”¨ç”¨æˆ· access_tokenï¼ˆlogto_tokenï¼‰\n  const accessToken = Taro.getStorageSync('logto_token')\n  return {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  }\n}\n\nexport default {\n  checkLoginStatus,\n  navigateToWebViewLoginSimple,\n  handleLoginSuccess,\n  clearLoginData,\n  getAuthHeaders\n}\n"],"names":[],"sourceRoot":""}