{"version":3,"file":"common.js","mappings":";;;;;;;;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;ACrBA;AACA;AACA;;AAEA;AACA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;ACxLA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxCA;AAAA;AAAA;;AA0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAAA;AAKA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAGA;;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAPA;AAAA;AASA;AAAA;AAAA;AAAA;AACA;AAAA;AAGA;AAEA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAGA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AACA;AAlGA;AAAA;AAAA;AAoGA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/._src_config_index.ts","webpack://eco-viz-mini/._src_utils_api.ts","webpack://eco-viz-mini/._src_utils_auth.ts"],"sourcesContent":["// å°ç¨‹åºç¯å¢ƒé…ç½®\nconst ENV: 'dev' | 'prod' = 'dev'\n\nconst apiBaseUrls = {\n  dev: 'http://192.168.199.187:3000',\n  prod: 'https://ynsq.eboard.apps.aigrohub.com'\n} as const\n\nexport const config = {\n  env: ENV,\n  // API é…ç½®\n  api: {\n    baseUrl: apiBaseUrls[ENV]\n  },\n\n  // å¾®ä¿¡å°ç¨‹åºé…ç½®\n  weapp: {\n    appId: 'wxad0bc6972754b77c'\n  }\n}\n\nexport default config\n","import Taro from '@tarojs/taro'\nimport config from '../config'\nimport { wechatSilentLogin } from './auth'\n\n// è¯·æ±‚æ‹¦æˆªå™¨\nconst request = (url: string, options: RequestInit = {}) => {\n  const token = Taro.getStorageSync('logto_token')\n  \n  return new Promise((resolve, reject) => {\n    Taro.request({\n      url: `${config.api.baseUrl}${url}`,\n      method: options.method as any || 'GET',\n      header: {\n        'Content-Type': 'application/json',\n        ...(token && { 'Authorization': `Bearer ${token}` }),\n        ...options.headers\n      },\n      data: options.body ? JSON.parse(options.body as string) : undefined,\n      success: (res) => {\n        if (res.statusCode === 401) {\n          // Token è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶é‡æ–°é™é»˜ç™»å½•\n          Taro.removeStorageSync('logto_token')\n          Taro.removeStorageSync('user_info')\n          Taro.removeStorageSync('user_id')\n          Taro.removeStorageSync('token_expires_in')\n          Taro.removeStorageSync('login_timestamp')\n          // å°è¯•é‡æ–°é™é»˜ç™»å½•\n          wechatSilentLogin().catch(() => {\n            Taro.showToast({ title: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ‰“å¼€å°ç¨‹åº', icon: 'none' })\n          })\n          reject(new Error('ç™»å½•å·²è¿‡æœŸ'))\n          return\n        }\n        \n        if (res.statusCode >= 200 && res.statusCode < 300) {\n          resolve(res.data)\n        } else {\n          reject(new Error(`è¯·æ±‚å¤±è´¥: ${res.statusCode}`))\n        }\n      },\n      fail: (error) => {\n        reject(error)\n      }\n    })\n  })\n}\n\n// API æ–¹æ³•å°è£…\nexport const api = {\n  // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå°ç¨‹åºä¸“ç”¨æ¥å£ï¼‰\n  getUserInfo: () => request('/api/mini/my-account'),\n\n  // æ›´æ–°ä¸ªäººä¿¡æ¯\n  updateProfile: (data: { username?: string; primaryEmail?: string; primaryPhone?: string; name?: string }) => {\n    return request('/api/mini/my-account/update-profile', {\n      method: 'PUT',\n      body: JSON.stringify(data)\n    })\n  },\n\n  // ä¿®æ”¹å¯†ç \n  changePassword: (data: { currentPassword: string; newPassword: string }) => {\n    return request('/api/mini/my-account/change-password', {\n      method: 'POST',\n      body: JSON.stringify(data)\n    })\n  },\n \n  // å°ç¨‹åºï¼šè·å–åˆ†ç»„ï¼ˆå½“å‰ç”¨æˆ·å¯è§ï¼‰\n  getMiniGroups: () => request('/api/mini/groups'),\n\n  // å°ç¨‹åºï¼šè·å–è®¾å¤‡åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰\n  getMiniDevices: (params: { groupId?: string | number, page?: number, pageSize?: number, keyword?: string, search?: string, devicetype?: string }) => {\n    const query = new URLSearchParams()\n    if (params.groupId !== undefined) query.set('groupId', String(params.groupId))\n    if (params.page !== undefined) query.set('page', String(params.page))\n    if (params.pageSize !== undefined) query.set('pageSize', String(params.pageSize))\n    // search å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ï¼Œä¸åå°ä¿æŒä¸€è‡´\n    if (params.search) {\n      query.set('search', params.search)\n    } else if (params.keyword) {\n      query.set('keyword', params.keyword)\n    }\n    if (params.devicetype) {\n      query.set('devicetype', params.devicetype)\n    }\n    const qs = query.toString() ? `?${query.toString()}` : ''\n    return request(`/api/mini/devices${qs}`)\n  },\n  \n  // è·å–è®¾å¤‡è¯¦æƒ…ï¼ˆä¿ç•™åŸæœ‰ Web ç«¯æ¥å£ï¼Œå¦‚åç»­éœ€è¦ï¼‰\n  getDeviceDetail: (id: number) => request(`/api/devices/${id}`),\n  \n  // è·å–è®¾å¤‡å‚æ•°\n  getDeviceParameters: (id: number) => request(`/api/devices/${id}/parameters`),\n  \n  // æ ¹æ®å‚æ•°åç§°åˆ—è¡¨è·å–å‚æ•°è¯¦æƒ…\n  getParametersInfo: (parameterNames: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameterNames.join(','))\n    return request(`/api/parameters?${params.toString()}`)\n  },\n  \n  // è·å–è®¾å¤‡å†å²æ•°æ®\n  getDeviceHistoryData: (id: number, params: { parameters: string, startDate: string, endDate: string }) => {\n    const query = new URLSearchParams()\n    query.set('parameters', params.parameters)\n    query.set('startDate', params.startDate)\n    query.set('endDate', params.endDate)\n    return request(`/api/devices/${id}/history-data?${query.toString()}`)\n  },\n  \n  // è·å–è®¾å¤‡æ•°æ®\n  getDeviceData: (id: number, params?: any) => {\n    const queryString = params ? `?${new URLSearchParams(params).toString()}` : ''\n    return request(`/api/devices/${id}/et-data${queryString}`)\n  },\n\n  // å°ç¨‹åºï¼šè·å–è®¾å¤‡é˜ˆå€¼é…ç½®\n  getDeviceThresholds: (deviceSn: string) => request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds`),\n\n  // å°ç¨‹åºï¼šåˆ›å»ºæˆ–æ›´æ–°è®¾å¤‡é˜ˆå€¼é…ç½®\n  saveDeviceThreshold: (deviceSn: string, data: { id?: number, parameter: string, lowerThreshold?: number | null, upperThreshold?: number | null, enabled?: boolean, nodeScopeType?: 'lte' | 'gte' | null, nodeScopeValue?: string | number | null }) => {\n    return request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds`, {\n      method: 'POST',\n      body: JSON.stringify(data)\n    })\n  },\n\n  // å°ç¨‹åºï¼šåˆ é™¤è®¾å¤‡é˜ˆå€¼é…ç½®\n  deleteDeviceThreshold: (deviceSn: string, thresholdId: number) => {\n    const query = new URLSearchParams()\n    query.set('id', String(thresholdId))\n    return request(`/api/mini/devices/${encodeURIComponent(deviceSn)}/thresholds?${query.toString()}`, {\n      method: 'DELETE'\n    })\n  },\n\n  // å°ç¨‹åºï¼šè·å–æ¶ˆæ¯åˆ—è¡¨\n  getMessages: (params?: { page?: number, pageSize?: number, isRead?: 'true' | 'false' }) => {\n    const query = new URLSearchParams()\n    if (params?.page) query.set('page', String(params.page))\n    if (params?.pageSize) query.set('pageSize', String(params.pageSize))\n    if (params?.isRead) query.set('isRead', params.isRead)\n    const qs = query.toString() ? `?${query.toString()}` : ''\n    return request(`/api/mini/messages${qs}`)\n  },\n\n  // å°ç¨‹åºï¼šæ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»\n  markMessageRead: (messageId: number) => {\n    return request(`/api/mini/messages/${messageId}/read`, {\n      method: 'PUT'\n    })\n  },\n\n  // å°ç¨‹åºï¼šåˆ é™¤æ¶ˆæ¯\n  deleteMessage: (messageId: number) => {\n    return request(`/api/mini/messages/${messageId}`, {\n      method: 'DELETE'\n    })\n  },\n\n  // å°ç¨‹åºï¼šä¸€é”®æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»\n  markAllMessagesRead: () => {\n    return request('/api/mini/messages/read-all', {\n      method: 'PUT'\n    })\n  },\n\n  // è·å–å¢’æƒ…è®¾å¤‡æŒ‡æ ‡æ•°æ®ï¼ˆæœ€æ–°åˆ†æï¼‰\n  getMoistureIndicators: (deviceId: number, parameters: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameters.join(','))\n    return request(`/api/devices/${deviceId}/moisture-indicators?${params.toString()}`)\n  },\n\n  // è·å–æ°”è±¡è®¾å¤‡æŒ‡æ ‡æ•°æ®ï¼ˆæœ€æ–°åˆ†æï¼‰\n  getWeatherIndicators: (deviceId: number, parameters: string[]) => {\n    const params = new URLSearchParams()\n    params.set('parameters', parameters.join(','))\n    return request(`/api/devices/${deviceId}/analysis?type=weather&${params.toString()}`)\n  }\n}\n\nexport default api\n","import Taro from '@tarojs/taro'\nimport config from '../config'\n\n// æ£€æŸ¥ç™»å½•çŠ¶æ€\nexport const checkLoginStatus = async () => {\n  try {\n    // æ£€æŸ¥ logto_token\n    const accessToken = Taro.getStorageSync('logto_token')\n    const loginTimestamp = Taro.getStorageSync('login_timestamp')\n    const expiresIn = Taro.getStorageSync('token_expires_in')\n    \n    if (!accessToken || !loginTimestamp || !expiresIn) {\n      console.log('âŒ ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    // æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ\n    const now = Date.now()\n    const tokenAge = now - loginTimestamp\n    const maxAge = expiresIn * 1000 // è½¬æ¢ä¸ºæ¯«ç§’\n    \n    if (tokenAge > maxAge) {\n      console.log('âŒ Token å·²è¿‡æœŸï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€')\n      clearLoginData()\n      return { isLoggedIn: false }\n    }\n    \n    // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ\n    const userInfo = Taro.getStorageSync('user_info')\n    if (!userInfo) {\n      console.log('âŒ ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    console.log('âœ… ç™»å½•çŠ¶æ€æ£€æŸ¥æˆåŠŸ')\n    return {\n      isLoggedIn: true,\n      user: userInfo,\n      access_token: accessToken\n    }\n  } catch (error) {\n    console.error('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)\n    return { isLoggedIn: false }\n  }\n}\n\n// æ¸…é™¤ç™»å½•æ•°æ®\nexport const clearLoginData = () => {\n  try {\n    // æ¸…é™¤æ‰€æœ‰ç™»å½•ç›¸å…³çš„å­˜å‚¨\n    Taro.removeStorageSync('logto_token')\n    Taro.removeStorageSync('user_info')\n    Taro.removeStorageSync('user_id')\n    Taro.removeStorageSync('token_expires_in')\n    Taro.removeStorageSync('login_timestamp')\n    console.log('âœ… ç™»å½•æ•°æ®å·²æ¸…é™¤')\n  } catch (error) {\n    console.error('âŒ æ¸…é™¤ç™»å½•æ•°æ®å¤±è´¥:', error)\n  }\n}\n\n// è·å–å¸¦è®¤è¯å¤´çš„è¯·æ±‚é…ç½®\nexport const getAuthHeaders = () => {\n  // ä»…ä½¿ç”¨ç”¨æˆ· access_tokenï¼ˆlogto_tokenï¼‰\n  const accessToken = Taro.getStorageSync('logto_token')\n  return {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  }\n}\n\n// å…¨å±€ç™»å½•é”ï¼Œé˜²æ­¢å¹¶å‘è°ƒç”¨\nlet isLoggingIn = false\nlet loginPromise: Promise<{ success: boolean; user?: any; error?: string }> | null = null\n\n// å¾®ä¿¡é™é»˜ç™»å½•\nexport const wechatSilentLogin = async () => {\n  // å¦‚æœæ­£åœ¨ç™»å½•ï¼Œè¿”å›åŒä¸€ä¸ªPromise\n  if (isLoggingIn && loginPromise) {\n    console.log('â³ ç™»å½•æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾…ç»“æœ...')\n    return loginPromise\n  }\n\n  // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•\n  const existingToken = Taro.getStorageSync('logto_token')\n  const loginTimestamp = Taro.getStorageSync('login_timestamp')\n  const expiresIn = Taro.getStorageSync('token_expires_in')\n  \n  if (existingToken && loginTimestamp && expiresIn) {\n    const now = Date.now()\n    const tokenAge = now - loginTimestamp\n    const maxAge = expiresIn * 1000\n    // å¦‚æœtokenæœªè¿‡æœŸï¼Œç›´æ¥è¿”å›æˆåŠŸ\n    if (tokenAge <= maxAge) {\n      const userInfo = Taro.getStorageSync('user_info')\n      if (userInfo) {\n        console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œè·³è¿‡ç™»å½•æµç¨‹')\n        return {\n          success: true,\n          user: userInfo\n        }\n      }\n    }\n  }\n\n  // è®¾ç½®ç™»å½•é”\n  isLoggingIn = true\n  \n  // åˆ›å»ºç™»å½•Promise\n  loginPromise = (async () => {\n    try {\n      console.log('ğŸš€ å¼€å§‹å¾®ä¿¡é™é»˜ç™»å½•...')\n      \n      // 1. è·å–å¾®ä¿¡ç™»å½•code\n      const loginRes = await Taro.login()\n      if (!loginRes.code) {\n        throw new Error('è·å–å¾®ä¿¡ç™»å½•å‡­è¯å¤±è´¥')\n      }\n      \n      console.log('âœ… è·å–å¾®ä¿¡codeæˆåŠŸ')\n      \n      // 2. è°ƒç”¨åç«¯APIè¿›è¡Œç™»å½•\n      const response = await Taro.request({\n        url: `${config.api.baseUrl}/api/auth/mini-wechat-login`,\n        method: 'POST',\n        data: { code: loginRes.code },\n        header: {\n          'Content-Type': 'application/json'\n        }\n      })\n      \n      if (response.statusCode !== 200 || response.data.code !== 0) {\n        throw new Error(response.data.message || 'ç™»å½•å¤±è´¥')\n      }\n      \n      const { access_token, expires_in, user } = response.data.data\n      \n      if (!access_token) {\n        throw new Error('è·å–ç™»å½•å‡­è¯å¤±è´¥')\n      }\n      \n      // 3. å­˜å‚¨tokenå’Œç”¨æˆ·ä¿¡æ¯\n      Taro.setStorageSync('logto_token', access_token)\n      Taro.setStorageSync('token_expires_in', expires_in)\n      Taro.setStorageSync('login_timestamp', Date.now())\n      \n      if (user) {\n        Taro.setStorageSync('user_info', user)\n        if (user.id) {\n          Taro.setStorageSync('user_id', user.id)\n        }\n      }\n      \n      console.log('âœ… å¾®ä¿¡é™é»˜ç™»å½•æˆåŠŸ')\n      \n      return {\n        success: true,\n        user: user\n      }\n    } catch (error) {\n      console.error('âŒ å¾®ä¿¡é™é»˜ç™»å½•å¤±è´¥:', error)\n      const errorMsg = error instanceof Error ? error.message : 'ç™»å½•å¤±è´¥'\n      return {\n        success: false,\n        error: errorMsg\n      }\n    } finally {\n      // æ¸…é™¤ç™»å½•é”\n      isLoggingIn = false\n      loginPromise = null\n    }\n  })()\n\n  return loginPromise\n}\n\nexport default {\n  checkLoginStatus,\n  clearLoginData,\n  getAuthHeaders,\n  wechatSilentLogin\n}\n"],"names":[],"sourceRoot":""}