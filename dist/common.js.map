{"version":3,"file":"common.js","mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxBA;AAAA;AAAA;;AA4BA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AANA;AAAA;AAQA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AArCA;AAAA;AAAA;;AAwCA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAJA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AA9HA;AAAA;AAAA;;AAiIA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxCA;AAAA;AAAA;;AA0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/._src_config_index.ts","webpack://eco-viz-mini/._src_utils_auth.ts"],"sourcesContent":["// Â∞èÁ®ãÂ∫èÁéØÂ¢ÉÈÖçÁΩÆ\nexport const config = {\n  // API ÈÖçÁΩÆ - Âº∫Âà∂‰ΩøÁî®ÂºÄÂèëÁéØÂ¢É\n  api: {\n    baseUrl: 'http://192.168.199.63:3000' // Âº∫Âà∂‰ΩøÁî®ÂºÄÂèëÁéØÂ¢ÉURL\n  },\n  \n  // Logto ÈÖçÁΩÆ - ‰ΩøÁî®Êñ∞ÂàõÂª∫ÁöÑÂ∞èÁ®ãÂ∫èÂ∫îÁî®\n  logto: {\n    endpoint: 'https://login.eboard.apps.aigrohub.com',\n    appId: 'avmoloeby2yvj8bi6mwse', // ‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáè‰∏≠ÁöÑ App ID\n    apiResource: 'https://ynsq.eboard.apps.aigrohub.com/api',\n    redirectUri: 'http://192.168.199.63:3000/api/auth/mini-callback' // ‰ΩøÁî®ÂêéÁ´ØAPIÂõûË∞É\n  },\n  \n  // ÂæÆ‰ø°Â∞èÁ®ãÂ∫èÈÖçÁΩÆ\n  weapp: {\n    appId: 'wxad4bf04718ee7738'\n  }\n}\n\nexport default config\n","import Taro from '@tarojs/taro'\nimport config from '../config'\n\n// ÁîüÊàêÈöèÊú∫Â≠óÁ¨¶‰∏≤ - ‰ΩøÁî®Êõ¥ÂÆâÂÖ®ÁöÑÂ≠óÁ¨¶ÈõÜ\nconst generateRandomString = (length: number) => {\n  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_' // ÁßªÈô§ . Âíå ~ ÈÅøÂÖç URL ÁºñÁ†ÅÈóÆÈ¢ò\n  let result = ''\n  for (let i = 0; i < length; i++) {\n    result += charset.charAt(Math.floor(Math.random() * charset.length))\n  }\n  return result\n}\n\n// Â∞èÁ®ãÂ∫èÁéØÂ¢ÉÁöÑ Base64 ÁºñÁ†ÅÂÆûÁé∞\nconst base64Encode = (str: string) => {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\n  let result = ''\n  let i = 0\n  \n  while (i < str.length) {\n    const a = str.charCodeAt(i++)\n    const b = i < str.length ? str.charCodeAt(i++) : 0\n    const c = i < str.length ? str.charCodeAt(i++) : 0\n    \n    const bitmap = (a << 16) | (b << 8) | c\n    \n    result += chars.charAt((bitmap >> 18) & 63)\n    result += chars.charAt((bitmap >> 12) & 63)\n    result += i - 2 < str.length ? chars.charAt((bitmap >> 6) & 63) : '='\n    result += i - 1 < str.length ? chars.charAt(bitmap & 63) : '='\n  }\n  \n  return result\n}\n\n// ÁîüÊàê code_challenge (SHA256 + Base64URL)\nconst generateCodeChallenge = async (codeVerifier: string) => {\n  try {\n    // Âú®Â∞èÁ®ãÂ∫èÁéØÂ¢É‰∏≠ÔºåÊàë‰ª¨‰ΩøÁî® Web Crypto API ÁîüÊàêÁúüÊ≠£ÁöÑ SHA256\n    if (typeof crypto !== 'undefined' && crypto.subtle) {\n      const encoder = new TextEncoder()\n      const data = encoder.encode(codeVerifier)\n      const hash = await crypto.subtle.digest('SHA-256', data)\n      \n      // ËΩ¨Êç¢‰∏∫ Base64URL\n      const base64 = base64Encode(String.fromCharCode(...new Uint8Array(hash)))\n      const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n      \n      // SHA256ÁöÑBase64URLÁºñÁ†ÅÂ∫îËØ•ÊòØ43‰∏™Â≠óÁ¨¶\n      return base64url\n    } else {\n      throw new Error('Web Crypto API not available')\n    }\n  } catch (error) {\n    console.warn('SHA256 failed, using fallback:', error)\n    // ÈôçÁ∫ßÊñπÊ°àÔºö‰ΩøÁî®ÁÆÄÂçïÁöÑ Base64 ÁºñÁ†ÅÔºà‰ªÖÁî®‰∫éÊµãËØïÔºâ\n    const base64 = base64Encode(codeVerifier)\n    const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n    return base64url\n  }\n}\n\n\n\n// WebView ÁôªÂΩï - ‰ΩøÁî®ÁÆÄÂåñÁöÑ‰ºöËØùIDÊñπÊ°à\nexport const navigateToWebViewLoginSimple = async () => {\n  try {\n    console.log('üöÄ ËØ∑Ê±ÇÂêéÁ´ØÁîüÊàêPKCEÂèÇÊï∞...')\n    \n    // Ë∞ÉÁî®ÂêéÁ´ØAPIÁîüÊàêPKCEÂèÇÊï∞\n    const response = await Taro.request({\n      url: `${config.api.baseUrl}/api/auth/mini-pkce`,\n      method: 'GET',\n      header: {\n        'Content-Type': 'application/json'\n      }\n    })\n    \n    if (response.statusCode === 200 && response.data.code === 0) {\n      const pkceData = response.data.data\n      console.log('‚úÖ PKCEÂèÇÊï∞Ëé∑ÂèñÊàêÂäü:', pkceData.loginUrl.substring(0, 100) + '...')\n      \n      // Â≠òÂÇ® code_verifier Áî®‰∫éÂêéÁª≠ÁöÑ token ‰∫§Êç¢\n      Taro.setStorageSync('pkce_code_verifier', pkceData.codeVerifier)\n      \n      // Ë∑≥ËΩ¨Âà∞WebViewÈ°µÈù¢\n      const encodedUrl = encodeURIComponent(pkceData.loginUrl)\n      const encodedCodeVerifier = encodeURIComponent(pkceData.codeVerifier)\n      \n      Taro.navigateTo({\n        url: `/pages/webview/index?url=${encodedUrl}&code_verifier=${encodedCodeVerifier}`\n      })\n    } else {\n      throw new Error(response.data.message || 'PKCEÂèÇÊï∞ÁîüÊàêÂ§±Ë¥•')\n    }\n  } catch (error) {\n    console.error('‚ùå WebViewÁôªÂΩïÂ§±Ë¥•:', error)\n    Taro.showToast({\n      title: 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï',\n      icon: 'none'\n    })\n  }\n}\n\n\n// ÁôªÂΩïÊàêÂäüÂêéÂ§ÑÁêÜÔºàÊúçÂä°Á´Ø‰ª£ÁêÜÊ®°ÂºèÔºâ\nexport const handleLoginSuccess = async (tempToken: string) => {\n  try {\n    console.log('üîÑ Â§ÑÁêÜ‰∏¥Êó∂ tokenÔºàÊú¨Âú∞Ëß£ÊûêÔºâ...')\n    console.log('Temp token length:', tempToken ? tempToken.length : 0)\n\n    // ========== Â∞èÁ®ãÂ∫èÂÆâÂÖ®ÁöÑ Base64URL Ëß£Á†Å ==========\n    const safeBase64UrlDecodeToString = (input: string): string => {\n      // Â∞Ü Base64URL ËΩ¨‰∏∫Ê†áÂáÜ Base64ÔºåÂπ∂Ë°•ÈΩê '='\n      const base64 = input.replace(/-/g, '+').replace(/_/g, '/')\n      const padLen = (4 - (base64.length % 4)) % 4\n      const padded = base64 + '='.repeat(padLen)\n\n      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\n      const rev: Record<string, number> = {}\n      for (let i = 0; i < alphabet.length; i++) rev[alphabet[i]] = i\n\n      const bytes: Array<number> = []\n      let buffer = 0\n      let bits = 0\n      for (let i = 0; i < padded.length; i++) {\n        const c = padded[i]\n        if (c === '=') break\n        const val = rev[c]\n        if (val === undefined) continue\n        buffer = (buffer << 6) | val\n        bits += 6\n        if (bits >= 8) {\n          bits -= 8\n          const byte = (buffer >> bits) & 0xff\n          bytes.push(byte)\n          buffer = buffer & ((1 << bits) - 1)\n        }\n      }\n\n      // UTF-8 Ëß£Á†Å\n      let out = ''\n      for (let i = 0; i < bytes.length; ) {\n        const b0 = bytes[i++]\n        if (b0 < 0x80) {\n          out += String.fromCharCode(b0)\n        } else if (b0 >= 0xc0 && b0 < 0xe0) {\n          const b1 = bytes[i++]\n          out += String.fromCharCode(((b0 & 0x1f) << 6) | (b1 & 0x3f))\n        } else if (b0 >= 0xe0 && b0 < 0xf0) {\n          const b1 = bytes[i++]\n          const b2 = bytes[i++]\n          out += String.fromCharCode(\n            ((b0 & 0x0f) << 12) | ((b1 & 0x3f) << 6) | (b2 & 0x3f)\n          )\n        } else {\n          // Ë∂ÖËøá BMP ÁöÑÂ≠óÁ¨¶Ôºà4 Â≠óËäÇÔºâÔºåËΩ¨‰∏∫‰ª£ÁêÜÂØπ\n          const b1 = bytes[i++]\n          const b2 = bytes[i++]\n          const b3 = bytes[i++]\n          let codePoint =\n            ((b0 & 0x07) << 18) | ((b1 & 0x3f) << 12) | ((b2 & 0x3f) << 6) | (b3 & 0x3f)\n          codePoint -= 0x10000\n          out += String.fromCharCode(0xd800 + ((codePoint >> 10) & 0x3ff))\n          out += String.fromCharCode(0xdc00 + (codePoint & 0x3ff))\n        }\n      }\n      return out\n    }\n\n    // tempToken ‰∏∫ base64URL(JSON.stringify({ access_token, expires_in, timestamp }))\n    const decodedStr = safeBase64UrlDecodeToString(tempToken)\n    const decoded = JSON.parse(decodedStr) as { access_token: string; expires_in?: number; timestamp?: number }\n\n    if (!decoded || !decoded.access_token) {\n      throw new Error('Êó†ÊïàÁöÑ‰∏¥Êó∂Âá≠ËØÅ')\n    }\n\n    const accessToken = decoded.access_token\n    const expiresIn = decoded.expires_in || 3600\n\n    // Â≠òÂÇ®Áî®Êà∑ access_tokenÔºà‰∏éÂêéÁ´ØÁªü‰∏ÄÔºâ\n    Taro.setStorageSync('logto_token', accessToken)\n    Taro.setStorageSync('token_expires_in', expiresIn)\n    Taro.setStorageSync('login_timestamp', Date.now())\n\n    // Ê∏ÖÈô§‰∏¥Êó∂ÁôªÂΩïÁä∂ÊÄÅ\n    Taro.removeStorageSync('pkce_code_verifier')\n\n    // Â∞ùËØïÈÄöËøáÂêéÁ´Ø API Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºàËÄå‰∏çÊòØÁõ¥Êé•Ë∞ÉÁî® LogtoÔºâ\n    try {\n      const meResp = await Taro.request({\n        url: `${config.api.baseUrl}/api/me/data`,\n        method: 'GET',\n        header: getAuthHeaders()\n      })\n\n      if (meResp.statusCode === 200 && meResp.data && meResp.data.code === 0) {\n        const userData = meResp.data.data\n        if (userData?.user) {\n          const userInfo = userData.user\n          Taro.setStorageSync('user_info', userInfo)\n          // ÁºìÂ≠ò userId Áî®‰∫éËØ∑Ê±ÇÈÄè‰º†\n          if (userInfo.id) {\n            Taro.setStorageSync('user_id', userInfo.id)\n          }\n          console.log('‚úÖ Áî®Êà∑‰ø°ÊÅØÂ∑≤Ëé∑ÂèñÂπ∂ÁºìÂ≠ò')\n        }\n      }\n    } catch (e) {\n      console.warn('‚ö†Ô∏è Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•ÔºàÂèØÂøΩÁï•Ôºå‰∏çÂΩ±ÂìçÁôªÂΩïÔºâ:', e)\n      // ‰∏çÂΩ±ÂìçÁôªÂΩïÊµÅÁ®ãÔºåÁªßÁª≠ÊâßË°å\n    }\n\n    console.log('‚úÖ ÁôªÂΩïÊàêÂäüÔºå‰ª§ÁâåÂ∑≤Â≠òÂÇ®')\n    Taro.showToast({ title: 'ÁôªÂΩïÊàêÂäü', icon: 'success' })\n\n    // Ë∑≥ËΩ¨Âà∞È¶ñÈ°µ\n    setTimeout(() => {\n      Taro.redirectTo({ \n        url: '/pages/home/index',\n        fail: () => {\n          // Â¶ÇÊûú redirectTo Â§±Ë¥•Ôºå‰ΩøÁî® reLaunch\n          Taro.reLaunch({ url: '/pages/home/index' })\n        }\n      })\n    }, 1000)\n  } catch (error) {\n    console.error('‚ùå Â§ÑÁêÜ‰∏¥Êó∂ token Â§±Ë¥•:', error)\n    const errorMsg = error instanceof Error ? error.message : 'ÁôªÂΩïÈ™åËØÅÂ§±Ë¥•'\n    Taro.showToast({ title: errorMsg, icon: 'none' })\n  }\n}\n\n\n// Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ\nexport const checkLoginStatus = async () => {\n  try {\n    // Ê£ÄÊü• logto_tokenÔºàWebViewÁôªÂΩïÔºâ\n    const accessToken = Taro.getStorageSync('logto_token')\n    const loginTimestamp = Taro.getStorageSync('login_timestamp')\n    const expiresIn = Taro.getStorageSync('token_expires_in')\n    \n    if (!accessToken || !loginTimestamp || !expiresIn) {\n      console.log('‚ùå ÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•ÔºöÁº∫Â∞ëÂøÖË¶Å‰ø°ÊÅØ')\n      return { isLoggedIn: false }\n    }\n    \n    // Ê£ÄÊü• token ÊòØÂê¶ËøáÊúü\n    const now = Date.now()\n    const tokenAge = now - loginTimestamp\n    const maxAge = expiresIn * 1000 // ËΩ¨Êç¢‰∏∫ÊØ´Áßí\n    \n    if (tokenAge > maxAge) {\n      console.log('‚ùå Token Â∑≤ËøáÊúüÔºåÊ∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ')\n      clearLoginData()\n      return { isLoggedIn: false }\n    }\n    \n    // È™åËØÅ token ÊòØÂê¶ÊúâÊïà\n    const userInfo = Taro.getStorageSync('user_info')\n    if (!userInfo) {\n      console.log('‚ùå Áº∫Â∞ëÁî®Êà∑‰ø°ÊÅØ')\n      return { isLoggedIn: false }\n    }\n    \n    console.log('‚úÖ ÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü•ÊàêÂäü')\n    return {\n      isLoggedIn: true,\n      user: userInfo,\n      access_token: accessToken\n    }\n  } catch (error) {\n    console.error('‚ùå Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error)\n    return { isLoggedIn: false }\n  }\n}\n\n// Ê∏ÖÈô§ÁôªÂΩïÊï∞ÊçÆ\nexport const clearLoginData = () => {\n  try {\n    // Ê∏ÖÈô§ÊâÄÊúâÁôªÂΩïÁõ∏ÂÖ≥ÁöÑÂ≠òÂÇ®\n    Taro.removeStorageSync('logto_token')\n    Taro.removeStorageSync('user_info')\n    Taro.removeStorageSync('user_id')\n    Taro.removeStorageSync('token_expires_in')\n    Taro.removeStorageSync('login_timestamp')\n    Taro.removeStorageSync('pkce_code_verifier')\n    console.log('‚úÖ ÁôªÂΩïÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§')\n  } catch (error) {\n    console.error('‚ùå Ê∏ÖÈô§ÁôªÂΩïÊï∞ÊçÆÂ§±Ë¥•:', error)\n  }\n}\n\n// Ëé∑ÂèñÂ∏¶ËÆ§ËØÅÂ§¥ÁöÑËØ∑Ê±ÇÈÖçÁΩÆ\nexport const getAuthHeaders = () => {\n  // ‰ªÖ‰ΩøÁî®Áî®Êà∑ access_tokenÔºàlogto_tokenÔºâ\n  const accessToken = Taro.getStorageSync('logto_token')\n  return {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  }\n}\n\nexport default {\n  checkLoginStatus,\n  navigateToWebViewLoginSimple,\n  handleLoginSuccess,\n  clearLoginData,\n  getAuthHeaders\n}\n"],"names":[],"sourceRoot":""}