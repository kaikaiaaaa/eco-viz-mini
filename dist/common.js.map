{"version":3,"file":"common.js","mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxBA;AAAA;AAAA;;AA4BA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AANA;AAAA;AAQA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AArCA;AAAA;AAAA;;AAwCA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AAGA;AACA;AACA;;AAEA;AACA;;AAEA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAJA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AApEA;AAAA;AAAA;;AAuEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAxCA;AAAA;AAAA;;AA0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://eco-viz-mini/._src_config_index.ts","webpack://eco-viz-mini/._src_utils_auth.ts"],"sourcesContent":["// å°ç¨‹åºç¯å¢ƒé…ç½®\nexport const config = {\n  // API é…ç½® - å¼ºåˆ¶ä½¿ç”¨å¼€å‘ç¯å¢ƒ\n  api: {\n    baseUrl: 'http://192.168.199.63:3000' // å¼ºåˆ¶ä½¿ç”¨å¼€å‘ç¯å¢ƒURL\n  },\n  \n  // Logto é…ç½® - ä½¿ç”¨æ–°åˆ›å»ºçš„å°ç¨‹åºåº”ç”¨\n  logto: {\n    endpoint: 'https://login.eboard.apps.aigrohub.com',\n    appId: 'avmoloeby2yvj8bi6mwse', // ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ App ID\n    apiResource: 'https://ynsq.eboard.apps.aigrohub.com/api',\n    redirectUri: 'http://192.168.199.63:3000/api/auth/mini-callback' // ä½¿ç”¨åç«¯APIå›è°ƒ\n  },\n  \n  // å¾®ä¿¡å°ç¨‹åºé…ç½®\n  weapp: {\n    appId: 'wxad4bf04718ee7738'\n  }\n}\n\nexport default config\n","import Taro from '@tarojs/taro'\nimport config from '../config'\n\n// ç”Ÿæˆéšæœºå­—ç¬¦ä¸² - ä½¿ç”¨æ›´å®‰å…¨çš„å­—ç¬¦é›†\nconst generateRandomString = (length: number) => {\n  const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_' // ç§»é™¤ . å’Œ ~ é¿å… URL ç¼–ç é—®é¢˜\n  let result = ''\n  for (let i = 0; i < length; i++) {\n    result += charset.charAt(Math.floor(Math.random() * charset.length))\n  }\n  return result\n}\n\n// å°ç¨‹åºç¯å¢ƒçš„ Base64 ç¼–ç å®ç°\nconst base64Encode = (str: string) => {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\n  let result = ''\n  let i = 0\n  \n  while (i < str.length) {\n    const a = str.charCodeAt(i++)\n    const b = i < str.length ? str.charCodeAt(i++) : 0\n    const c = i < str.length ? str.charCodeAt(i++) : 0\n    \n    const bitmap = (a << 16) | (b << 8) | c\n    \n    result += chars.charAt((bitmap >> 18) & 63)\n    result += chars.charAt((bitmap >> 12) & 63)\n    result += i - 2 < str.length ? chars.charAt((bitmap >> 6) & 63) : '='\n    result += i - 1 < str.length ? chars.charAt(bitmap & 63) : '='\n  }\n  \n  return result\n}\n\n// ç”Ÿæˆ code_challenge (SHA256 + Base64URL)\nconst generateCodeChallenge = async (codeVerifier: string) => {\n  try {\n    // åœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Web Crypto API ç”ŸæˆçœŸæ­£çš„ SHA256\n    if (typeof crypto !== 'undefined' && crypto.subtle) {\n      const encoder = new TextEncoder()\n      const data = encoder.encode(codeVerifier)\n      const hash = await crypto.subtle.digest('SHA-256', data)\n      \n      // è½¬æ¢ä¸º Base64URL\n      const base64 = base64Encode(String.fromCharCode(...new Uint8Array(hash)))\n      const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n      \n      // SHA256çš„Base64URLç¼–ç åº”è¯¥æ˜¯43ä¸ªå­—ç¬¦\n      return base64url\n    } else {\n      throw new Error('Web Crypto API not available')\n    }\n  } catch (error) {\n    console.warn('SHA256 failed, using fallback:', error)\n    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ç®€å•çš„ Base64 ç¼–ç ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰\n    const base64 = base64Encode(codeVerifier)\n    const base64url = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '')\n    return base64url\n  }\n}\n\n\n\n// WebView ç™»å½• - ä½¿ç”¨ç®€åŒ–çš„ä¼šè¯IDæ–¹æ¡ˆ\nexport const navigateToWebViewLoginSimple = async () => {\n  try {\n    console.log('ğŸš€ è¯·æ±‚åç«¯ç”ŸæˆPKCEå‚æ•°...')\n    \n    // è°ƒç”¨åç«¯APIç”ŸæˆPKCEå‚æ•°\n    const response = await Taro.request({\n      url: `${config.api.baseUrl}/api/auth/mini-pkce`,\n      method: 'GET',\n      header: {\n        'Content-Type': 'application/json'\n      }\n    })\n    \n    if (response.statusCode === 200 && response.data.code === 0) {\n      const pkceData = response.data.data\n      console.log('âœ… PKCEå‚æ•°è·å–æˆåŠŸ:', pkceData.loginUrl.substring(0, 100) + '...')\n      \n      // å­˜å‚¨ code_verifier ç”¨äºåç»­çš„ token äº¤æ¢\n      Taro.setStorageSync('pkce_code_verifier', pkceData.codeVerifier)\n      \n      // è·³è½¬åˆ°WebViewé¡µé¢\n      const encodedUrl = encodeURIComponent(pkceData.loginUrl)\n      const encodedCodeVerifier = encodeURIComponent(pkceData.codeVerifier)\n      \n      Taro.navigateTo({\n        url: `/pages/webview/index?url=${encodedUrl}&code_verifier=${encodedCodeVerifier}`\n      })\n    } else {\n      throw new Error(response.data.message || 'PKCEå‚æ•°ç”Ÿæˆå¤±è´¥')\n    }\n  } catch (error) {\n    console.error('âŒ WebViewç™»å½•å¤±è´¥:', error)\n    Taro.showToast({\n      title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',\n      icon: 'none'\n    })\n  }\n}\n\n\n// ç™»å½•æˆåŠŸåå¤„ç†ï¼ˆæœåŠ¡ç«¯ä»£ç†æ¨¡å¼ï¼‰\nexport const handleLoginSuccess = async (tempToken: string) => {\n  try {\n    console.log('ğŸ”„ å¤„ç†ä¸´æ—¶ tokenï¼ˆæœ¬åœ°è§£æï¼‰...')\n    console.log('Temp token length:', tempToken ? tempToken.length : 0)\n\n    // tempToken ä¸º base64(JSON.stringify({ access_token, expires_in, timestamp }))\n    const decoded = JSON.parse(\n      decodeURIComponent(escape(atob(tempToken)))\n    ) as { access_token: string; expires_in?: number; timestamp?: number }\n\n    if (!decoded || !decoded.access_token) {\n      throw new Error('æ— æ•ˆçš„ä¸´æ—¶å‡­è¯')\n    }\n\n    const accessToken = decoded.access_token\n    const expiresIn = decoded.expires_in || 3600\n\n    // å­˜å‚¨ç”¨æˆ· access_tokenï¼ˆä¸åç«¯ç»Ÿä¸€ï¼‰\n    Taro.setStorageSync('logto_token', accessToken)\n    Taro.setStorageSync('token_expires_in', expiresIn)\n    Taro.setStorageSync('login_timestamp', Date.now())\n\n    // æ¸…é™¤ä¸´æ—¶ç™»å½•çŠ¶æ€\n    Taro.removeStorageSync('pkce_code_verifier')\n\n    // å°è¯•é€šè¿‡åç«¯ API è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ Logtoï¼‰\n    try {\n      const meResp = await Taro.request({\n        url: `${config.api.baseUrl}/api/me/data`,\n        method: 'GET',\n        header: getAuthHeaders()\n      })\n\n      if (meResp.statusCode === 200 && meResp.data && meResp.data.code === 0) {\n        const userData = meResp.data.data\n        if (userData?.user) {\n          const userInfo = userData.user\n          Taro.setStorageSync('user_info', userInfo)\n          // ç¼“å­˜ userId ç”¨äºè¯·æ±‚é€ä¼ \n          if (userInfo.id) {\n            Taro.setStorageSync('user_id', userInfo.id)\n          }\n          console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²è·å–å¹¶ç¼“å­˜')\n        }\n      }\n    } catch (e) {\n      console.warn('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ˆå¯å¿½ç•¥ï¼Œä¸å½±å“ç™»å½•ï¼‰:', e)\n      // ä¸å½±å“ç™»å½•æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ\n    }\n\n    console.log('âœ… ç™»å½•æˆåŠŸï¼Œä»¤ç‰Œå·²å­˜å‚¨')\n    Taro.showToast({ title: 'ç™»å½•æˆåŠŸ', icon: 'success' })\n\n    // è·³è½¬åˆ°é¦–é¡µ\n    setTimeout(() => {\n      Taro.redirectTo({ \n        url: '/pages/home/index',\n        fail: () => {\n          // å¦‚æœ redirectTo å¤±è´¥ï¼Œä½¿ç”¨ reLaunch\n          Taro.reLaunch({ url: '/pages/home/index' })\n        }\n      })\n    }, 1000)\n  } catch (error) {\n    console.error('âŒ å¤„ç†ä¸´æ—¶ token å¤±è´¥:', error)\n    const errorMsg = error instanceof Error ? error.message : 'ç™»å½•éªŒè¯å¤±è´¥'\n    Taro.showToast({ title: errorMsg, icon: 'none' })\n  }\n}\n\n\n// æ£€æŸ¥ç™»å½•çŠ¶æ€\nexport const checkLoginStatus = async () => {\n  try {\n    // æ£€æŸ¥ logto_tokenï¼ˆWebViewç™»å½•ï¼‰\n    const accessToken = Taro.getStorageSync('logto_token')\n    const loginTimestamp = Taro.getStorageSync('login_timestamp')\n    const expiresIn = Taro.getStorageSync('token_expires_in')\n    \n    if (!accessToken || !loginTimestamp || !expiresIn) {\n      console.log('âŒ ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    // æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ\n    const now = Date.now()\n    const tokenAge = now - loginTimestamp\n    const maxAge = expiresIn * 1000 // è½¬æ¢ä¸ºæ¯«ç§’\n    \n    if (tokenAge > maxAge) {\n      console.log('âŒ Token å·²è¿‡æœŸï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€')\n      clearLoginData()\n      return { isLoggedIn: false }\n    }\n    \n    // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ\n    const userInfo = Taro.getStorageSync('user_info')\n    if (!userInfo) {\n      console.log('âŒ ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯')\n      return { isLoggedIn: false }\n    }\n    \n    console.log('âœ… ç™»å½•çŠ¶æ€æ£€æŸ¥æˆåŠŸ')\n    return {\n      isLoggedIn: true,\n      user: userInfo,\n      access_token: accessToken\n    }\n  } catch (error) {\n    console.error('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error)\n    return { isLoggedIn: false }\n  }\n}\n\n// æ¸…é™¤ç™»å½•æ•°æ®\nexport const clearLoginData = () => {\n  try {\n    // æ¸…é™¤æ‰€æœ‰ç™»å½•ç›¸å…³çš„å­˜å‚¨\n    Taro.removeStorageSync('logto_token')\n    Taro.removeStorageSync('user_info')\n    Taro.removeStorageSync('user_id')\n    Taro.removeStorageSync('token_expires_in')\n    Taro.removeStorageSync('login_timestamp')\n    Taro.removeStorageSync('pkce_code_verifier')\n    console.log('âœ… ç™»å½•æ•°æ®å·²æ¸…é™¤')\n  } catch (error) {\n    console.error('âŒ æ¸…é™¤ç™»å½•æ•°æ®å¤±è´¥:', error)\n  }\n}\n\n// è·å–å¸¦è®¤è¯å¤´çš„è¯·æ±‚é…ç½®\nexport const getAuthHeaders = () => {\n  // ä»…ä½¿ç”¨ç”¨æˆ· access_tokenï¼ˆlogto_tokenï¼‰\n  const accessToken = Taro.getStorageSync('logto_token')\n  return {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  }\n}\n\nexport default {\n  checkLoginStatus,\n  navigateToWebViewLoginSimple,\n  handleLoginSuccess,\n  clearLoginData,\n  getAuthHeaders\n}\n"],"names":[],"sourceRoot":""}